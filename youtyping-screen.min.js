!function(a){function b(a){var b=new Date,d=c(b.getHours(),2),e=c(b.getMinutes(),2),f=c(b.getSeconds(),2),g=c(b.getMilliseconds(),3);$("#debug").append("["+d+":"+e+":"+f+"."+g+"] "+a+"\n"),console.log(a)}function c(a,b){return a=a.toString(),a.length<b?c("0"+a,b):a}var d=function(a,c){var d=this,e=0;this.items={},this.settings={width:1120,height:630,hitPosition:.4,speed:.5,noteSize:50,lyricSize:20,rollYpos:.5,longLineHeight:150,lineHeight:120,screenPadding:30,bufferTextPosition:[.2,.8],currentLyricPosition:[.5,.25],nextLyricPosition:[.5,.3],kanaLyricPosition:[.5,.8],scoreTextPosition:[.9,.1],judgeColors:{perfect:"yellow",great:"#2d1",good:"#19a",bad:"#aaa",failed:"#a34",neglect:"#39a"},cursorHideTime:1e3,onGameEnd:function(){},highScore:0,"3d":!1,romaji:!0};var f={videoId:"fQ_m5VLhqNg",videoStop:0,dataFile:"data.utx",tableFile:"convert/romaji.xml",initial:!1,correction:0,controlledCorrection:0,offset:0,volume:100,playbackQuality:"default",screen:d,mercyBorder:13.5};this.initialize=function(){paper.setup(d.canvas),d.cover=new paper.Path.Rectangle(paper.view.bounds),d.cover.fillColor="black",d.cover.fillColor.alpha=.7,d.debugTexts=[];for(var a=0;7>a;a++){var f=d.debugTexts.push(new paper.PointText([20,20*(a+1)]));d.debugText=d.debugTexts[f-1],d.debugText.justification="left",d.debugText.fillColor="white"}d.scoreText=new paper.PointText({point:paper.view.bounds.bottomRight.multiply(c.scoreTextPosition),content:"0",fillColor:"white",justification:"right",fontSize:36}),d.bufferText=new paper.PointText({point:paper.view.bounds.bottomRight.multiply(c.bufferTextPosition),content:"",fillColor:"white",justification:"left",fontSize:24}),d.currentLyric=new paper.Group,d.nextLyric=new paper.Group,d.kanaLyric=new paper.PointText({point:paper.view.bounds.bottomRight.multiply(c.kanaLyricPosition),content:"",fillColor:"white",justification:"center",fontSize:24}),d.judgeEffects=new paper.Group,setInterval(function(){d.debugTexts[0].content="FPS: "+e,e=0,d.debugTexts[2].content="Zerocall FPS: "+l.zeroCallFPS,l.zeroCallFPS=0},1e3),d.scorePad=0,d.highScore=d.settings.highScore,d.newRecord=!1,b("Screen Initialized.")},this.onResourceReady=function(){var a=l.now,e=c.width*(1-c.hitPosition)+c.noteSize+c.screenPadding,f=c.width*c.hitPosition+c.noteSize+c.screenPadding;try{l.roll.forEach(function(a){a.emergeTime=(c.speed*a.time-e)/c.speed,a.vanishTime=(c.speed*a.time+f)/c.speed}),b("Computed roll Parameters.")}catch(g){return b("ERROR: Computing roll Parameters Faild: "+g),-1}l.zeroTime=a,d.update(),d.hitCircle=new paper.Path.Circle({center:paper.view.bounds.bottomRight.multiply([c.hitPosition,c.rollYpos]),radius:c.noteSize,strokeWidth:1,strokeColor:"white"}),d.nextLyric.content=null!==l.nextLyricIndex?l.roll[l.nextLyricIndex].text:""},this.onGameReady=function(){d.pressEnter=new paper.PointText({point:paper.view.bounds.bottomRight.multiply([.5,.8]),content:"Press enter or click here.",justification:"center",fontSize:45,fillColor:"white"});var a=function(a){("keydown"===a.type&&"enter"===a.key||"mousedown"===a.type)&&(d.pressEnter.remove(),paper.tool.onKeyDown=null,d.start())};paper.tool.onKeyDown=a,d.pressEnter.onMouseDown=a,b("Game is Ready.")},this.start=function(){b("Starting game."),paper.view.onFrame=d.onFrame,l.play(),paper.tool.onKeyDown=g};var g=function(a){"keydown"===a.type&&"escape"===a.key&&(a.preventDefault(),d.reset()),1===l.player.getPlayerState()&&"keydown"===a.type&&(a.preventDefault(),l.hit(a.key))};this.reset=function(){l.reset();for(var a in d.items)d.items.hasOwnProperty(a)&&d.items[a].remove();d.items={},d.hitCircle.remove(),d.onResourceReady(),d.onGameReady()},this.update=function(){var a=d.items,b=l.now,e=b-l.zeroTime;l.roll.forEach(function(b,f){var g=(b.time-e)*c.speed+c.width*c.hitPosition;if(f in a){if(e<b.emergeTime||b.vanishTime<e)return a[f].remove(),void delete a[f]}else{if(!(b.emergeTime<=e&&e<=b.vanishTime))return;a[f]=new paper.Group,b.type===l.itemType.LONGLINE&&(a[f].longLine=a[f].addChild(new paper.Path.Line({from:[g,c.rollYpos*c.height-c.longLineHeight/2],to:[g,c.rollYpos*c.height+c.longLineHeight/2],strokeColor:"white",strokeWidth:2}))),b.type===l.itemType.LINE&&(a[f].smallLine=a[f].addChild(new paper.Path.Line({from:[g,c.rollYpos*c.height-c.lineHeight/2],to:[g,c.rollYpos*c.height+c.lineHeight/2],strokeColor:"white",strokeWidth:1}))),b.type===l.itemType.NOTE&&(a[f].note=a[f].addChild(new paper.Path.Circle({center:[g,c.rollYpos*c.height],radius:c.noteSize,strokeWidth:1,strokeColor:"white"})),a[f].lyric=a[f].addChild(new paper.PointText({point:[g,c.rollYpos*c.height+c.noteSize+50],content:b.remainingText,fillColor:"white",justification:"center",fontSize:c.lyricSize,fontFamily:"sans-serif"})),d.settings.romaji&&(a[f].romaji=a[f].addChild(new paper.PointText({point:[g,c.rollYpos*c.height+c.noteSize+80],content:b.remainingRomaji,fillColor:"white",justification:"center",fontSize:c.lyricSize,fontFamily:"sans-serif"})),a[f].mercy=a[f].addChild(new paper.PointText({point:[g,c.rollYpos*c.height+c.noteSize+110],content:b.mercy?b.mercy:"",fillColor:"white",justification:"center",fontSize:c.lyricSize,fontFamily:"sans-serif"})))),b.type===l.itemType.STOP&&(a[f].orderStop=a[f].addChild(new paper.Path({segments:[[g,c.rollYpos*c.height-c.noteSize-30]],fillColor:"white"})),a[f].orderStop.lineBy([10,-10]),a[f].orderStop.lineBy([-20,0]),a[f].orderStop.closed=!0)}if(b.type===l.itemType.LONGLINE&&(a[f].position.x=g),b.type===l.itemType.LINE&&(a[f].position.x=g),b.type===l.itemType.STOP&&(a[f].position.x=g),b.type===l.itemType.NOTE)if(a[f].position.x=g,b.state===l.noteState.CLEARED)a[f].visible=!1;else{var h;switch(b.state){case l.noteState.WAITING:case l.noteState.HITTING:h=b.mercy?"orange":"red";break;default:h="#aaa"}a[f].note.style={fillColor:h},a[f].note.opacity=b.state===l.noteState.FAILED||b.state===l.noteState.WAITING?1:.5,a[f].lyric.content=b.remainingText,d.settings.romaji&&(a[f].romaji.content=b.remainingRomaji)}})},this.onFrame=function(){1===l.player.getPlayerState()&&d.update(),d.debugTexts[1].content="Measured Zero: "+l.estimatedZero.toFixed(2),d.debugTexts[3].content="Active Objects: "+paper.project.activeLayer.children.length,d.debugTexts[4].content="Zero Time: "+l.zeroTime.toFixed(2),d.debugTexts[5].content="Time: "+l.time.toFixed(2),d.bufferText.content=l.inputBuffer,d.scorePad+=.5*(l.score-d.scorePad),d.scoreText.content=Math.round(d.scorePad),d.judgeEffects.children.forEach(function(a){a.controller.onFrame()}),e++};var h=null;this.onPlayerStateChange=function(a){a.data===YT.PlayerState.PLAYING?paper.tool.onMouseMove=function(){$(d.DOM.screen).css({cursor:"auto"}),clearTimeout(h),h=setTimeout(function(){$(d.DOM.screen).css({cursor:"none"})},c.cursorHideTime)}:($(d.DOM.screen).css({cursor:"auto"}),clearTimeout(h),paper.tool.onMouseMove=null)},this.onJudgement=function(a){var b=new i(a.judgement);b.item.controller=b,d.judgeEffects.addChild(b.item)};var i=function(a){this.bornTime=new Date,this.item=new paper.Group,this.judgeColor=c.judgeColors[a.judge],this.judge=this.item.addChild(new paper.PointText({point:d.hitCircle.position.add([0,-c.noteSize-24]),content:a.judge,fillColor:this.judgeColor,justification:"center",fontSize:24,fontFamily:"sans-serif"})),this.combo=this.item.addChild(new paper.PointText({point:d.hitCircle.position.add([0,-c.noteSize]),content:a.combo,fillColor:"white",justification:"center",fontSize:15,fontFamily:"sans-serif"})),this.initialPosition=this.item.position,this.onFrame=function(){this.item.position.y=this.initialPosition.y-.2*(new Date-this.bornTime),this.item.opacity=1-.001*(new Date-this.bornTime),this.item.opacity<0&&this.item.remove()}};this.onLyricChange=function(){d.currentLyric.remove(),d.currentLyric=new paper.Group;var a;if(null!==l.currentLyricIndex){var b=l.roll[l.currentLyricIndex].text.split("¥|");a=0,b.forEach(function(b,e){var f=d.currentLyric.addChild(new paper.PointText({point:paper.view.bounds.bottomRight.multiply(c.currentLyricPosition).add([a,0]),content:b,fillColor:"white",justification:"left",opacity:e%2===0?1:.3,fontSize:36}));a+=f.bounds.width}),d.currentLyric.translate([-a/2,0])}if(d.nextLyric.remove(),d.nextLyric=new paper.Group,null!==l.nextLyricIndex){var e=l.roll[l.nextLyricIndex].text.split("¥|");a=0,e.forEach(function(b,e){var f=d.nextLyric.addChild(new paper.PointText({point:paper.view.bounds.bottomRight.multiply(c.nextLyricPosition).add([a,0]),content:b,fillColor:"white",justification:"left",opacity:e%2===0?1:.3,fontSize:18}));a+=f.bounds.width}),d.nextLyric.translate([-a/2,0])}},this.onGameEnd=function(){b("Game Ended."),paper.tool.onKeyDown=null,d.highScore<l.score&&(d.highScore=l.score,d.newRecord=!0),d.resultCover=new paper.Path.Rectangle(paper.view.bounds),d.resultCover.fillColor="#ddd",d.resultCover.fillColor.alpha=0,d.resultCover.onFrame=function(){this.fillColor.alpha+=.01,this.fillColor.alpha>=1&&(d.resultCover.onFrame=null,j())},d.settings.onGameEnd.call(d)};var j=function(){var a=paper.view.bounds.bottomRight;d.result=[],d.result.push(new paper.PointText({point:a.multiply([.2,0]).add([0,100]),content:"Result:",fillColor:"black",justification:"left",fontSize:48,fontFamily:"sans-serif"})),["perfect","great","good","bad","failed","neglect"].forEach(function(b,e){var f=new paper.Color(c.judgeColors[b]);f.brightness-=.3,f.saturation+=.2;var g=0;if("neglect"===b)g=l.scorebook.neglect;else if("failed"===b)for(var h in l.scorebook.failed)l.scorebook.failed.hasOwnProperty(h)&&(g+=l.scorebook.failed[h]);else g=l.scorebook.cleared[b];d.result.push(new paper.PointText({point:a.multiply([.2,0]).add([0,40*e+180]),content:b+": "+g,fillColor:f,justification:"left",fontSize:36,fontFamily:"sans-serif"}))}),d.result.push(new paper.PointText({point:a.multiply([.2,0]).add([0,450]),content:"Max Combo: "+l.maxCombo,fillColor:"black",justification:"left",fontSize:36,fontFamily:"sans-serif"})),d.result.push(new paper.PointText({point:a.multiply([.2,0]).add([0,500]),content:"Score: "+l.score,fillColor:"black",justification:"left",fontSize:36,fontFamily:"sans-serif"})),d.result.push(new paper.PointText({point:a.multiply([.2,0]).add([0,550]),content:"HighScore: "+d.highScore,fillColor:"black",justification:"left",fontSize:36,fontFamily:"sans-serif"}))};for(var k in c)c.hasOwnProperty(k)&&(void 0===this.settings[k]?this.settings[k]=c[k]:"number"==typeof this.settings[k]?this.settings[k]=parseFloat(c[k],10):"string"==typeof this.settings[k]?this.settings[k]=c[k]:"boolean"==typeof this.settings[k]?this.settings[k]=Boolean(c[k]):"function"==typeof this.settings[k]?this.settings[k]=c[k]:"object"==typeof this.settings[k]&&(this.settings[k]="object"==typeof c[k]?c[k]:JSON.parse(c[k])));for(k in f)f.hasOwnProperty(k)&&"undefined"!=typeof this.settings[k]&&(f[k]=this.settings[k]);c=this.settings,this.DOM={wrap:a.css({width:this.settings.width+"px",height:this.settings.height+"px",margin:"0 auto",position:"relative",perspective:this.settings["3d"]?"1000px":"0px"})[0],player:$("<div/>",{id:"youtyping-player"}).appendTo(a).css({width:this.settings.width+"px",height:this.settings.height+"px",display:"block","z-index":0,transform:this.settings["3d"]?"rotateY(-30deg) scale(0.8) translateX(-100px)":""})[0],screen:$("<canvas/>",{id:"youtyping-screen","data-paper-keepalive":"true",width:this.settings.width.toString(),height:this.settings.height.toString()}).appendTo(a).css({width:this.settings.width+"px",height:this.settings.height+"px",position:"absolute",top:0,left:0,"z-index":100})[0]},this.canvas=this.DOM.screen,f.width=this.settings.width,f.height=this.settings.height,this.youTyping=new YouTyping(this.DOM.player,f);var l=this.youTyping;l.addEventListener("resourceready",d.onResourceReady),l.addEventListener("gameready",d.onGameReady),l.addEventListener("playerstatechange",d.onPlayerStateChange),l.addEventListener("judgement",d.onJudgement),l.addEventListener("gameend",d.onGameEnd),l.addEventListener("lyricchange",d.onLyricChange),this.initialize()};if("undefined"==typeof window.performance&&(window.performance={}),!window.performance.now){var e=Date.now();window.performance.now=function(){return Date.now()-e}}String.prototype.mapsTo=function(a){for(var b in a)if(a.hasOwnProperty(b)&&this.valueOf()===b)return a[b];return null},a.Screen=d}("undefined"==typeof window?module.exports:window);
//# sourceMappingURL=youtyping-screen.min.map