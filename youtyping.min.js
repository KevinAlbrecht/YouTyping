/* youtyping.js 06-25-2014 */

var YouTyping=function(){function a(a){var b=new Date,d=c(b.getHours(),2),e=c(b.getMinutes(),2),f=c(b.getSeconds(),2),g=c(b.getMilliseconds(),3);$("#debug").append("["+d+":"+e+":"+f+"."+g+"] "+a+"\n"),console.log(a)}function b(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function c(a,b){return a=a.toString(),a.length<b?c("0"+a,b):a}var d=function(c,d){var f=this;this.noteState={WAITING:0,HITTING:1,CLEARED:2,HITTINGFAILED:3,FAILED:4};var h,i=function(){h=$.Deferred(),a("Setting Player Up...");var b=document.createElement("script");b.src="https://www.youtube.com/iframe_api";var c=document.getElementsByTagName("script")[0];return c.parentNode.insertBefore(b,c),h.promise()};window.onYouTubeIframeAPIReady=function(){var c=f.settings;a("Player API is Ready."),"true"===b("sandbox")&&this.DOM.player.setAttribute("sandbox","allow-same-origin allow-scripts"),f.player=new YT.Player("youtyping-player",{height:c.height,width:c.width,videoId:c.videoId,playerVars:{rel:0,start:c.offset,controls:0,showinfo:0,modestbranding:1,wmode:"opaque"},events:{onReady:l,onStateChange:m,onError:n}})};var j,k,l=function(){a("Player is Ready."),f.player.setVolume(f.settings.volume),f.player.setPlaybackQuality(f.settings.playbackQuality),h.resolve()},m=function(b){switch(v.onPlayerStateChange&&v.onPlayerStateChange.call(v,b),b.data){case YT.PlayerState.ENDED:a("Player Ended.");break;case YT.PlayerState.PLAYING:a("Player Started.");break;case YT.PlayerState.PAUSED:a("Player Paused.");break;case YT.PlayerState.BUFFERING:a("Player Buffering.");break;case YT.PlayerState.CUED:a("Player Cued.")}},n=function(b){switch(b.data){case 2:a("ERROR: The request contains an invalid parameter value. For example, this error occurs if you specify a video ID that does not have 11 characters, or if the video ID contains invalid characters, such as exclamation points or asterisks.");break;case 5:a("ERROR: The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred.");break;case 100:a("ERROR: The video requested was not found. This error occurs when a video has been removed (for any reason) or has been marked as private.");break;case 101:a("ERROR: The owner of the requested video does not allow it to be played in embedded players.");break;case 150:a("ERROR: The owner of the requested video does not allow it to be played in embedded players.")}h.reject()},o=function(){return j=$.Deferred(),$.ajax({url:f.settings.dataFile,type:"get",datatype:"xml",timeout:1e3,success:function(b){f.dataXML=$(b).find("data").first();var c=f.dataXML.find("roll > item");f.roll=[],$(c).each(function(){var a={time:1e3*parseFloat($(this).attr("time")),type:$(this).attr("type")};$(this).has("text")&&(a.text=a.remainingText=$(this).children("text").text()),"note"===a.type&&(a.state=f.noteState.WAITING),f.roll.push(a)}),f.nextLyricIndex=r(-1),a("Loaded XML File."),j.resolve()},error:function(b,c,d){a("ERROR: XML File Loading Failed: "+d),j.reject()}}),j.promise()},p=function(){return k=$.Deferred(),$.ajax({url:f.settings.tableFile,type:"get",datatype:"xml",timeout:1e3,success:function(b){try{f.table=[],$(b).find("table").find("rule").each(function(a){if(f.table.push({before:$(this).attr("before"),after:$(this).attr("after"),next:$(this).attr("next")}),$(this).attr("next")&&1!==$(this).attr("next").length)throw"Rule "+a+": next string must be one character"}),a("Loaded Table File."),k.resolve()}catch(c){a("ERROR: Table File Parsing Failed: "+c),k.reject()}},error:function(b,c,d){a("ERROR: Table File Loading Failed: "+d),k.reject()}}),k.promise()},q=function(a){for(var b=null,c=a+1;c<f.roll.length;c++){var d=f.roll[c];if("stop"===d.type){b=null;break}if("note"===d.type){b=c;break}}return b},r=function(a){for(var b=null,c=a+1;c<f.roll.length;c++){var d=f.roll[c];if("lyric"===d.type){b=c;break}}return b},s=function(){var a=f.player.getCurrentTime(),b=f.now;if(a===f.settings.offset)f.zeroTimePad=b-1e3*f.settings.offset+f.correction,f.zeroTime=b-1e3*f.settings.offset+f.correction;else if(f.currentTime!==a&&a>f.settings.offset){f.currentTime=a,f.estimatedZero=b-1e3*f.currentTime,f.estimateSamples.push(f.estimatedZero),f.estimateSamples.length>f.settings.zeroEstimateSamples&&f.estimateSamples.shift();var c=f.estimateSamples.reduce(function(a,b){return a+b});f.zeroTimePad=c/f.estimateSamples.length+f.correction,f.zeroCallFPS++}f.zeroTime=.9*(f.zeroTime-f.zeroTimePad)+f.zeroTimePad;var d=b-f.zeroTime,e=null,g=null;f.roll.forEach(function(a,b){"note"===a.type&&a.time+f.settings.failureSuspension<d?(a.state===f.noteState.WAITING||a.state===f.noteState.HITTING)&&(e&&(t(e),g===f.currentNoteIndex&&(f.currentNoteIndex=null,f.inputBuffer="")),e=a,g=b):"lyric"===a.type&&a.time<d?f.currentLyricIndex<b&&(f.currentLyricIndex=b,f.nextLyricIndex=r(b)):"stop"===a.type&&a.time<d&&(f.currentLyricIndex<b&&(f.currentLyricIndex=null),e&&(t(e),g===f.currentNoteIndex&&(f.currentNoteIndex=null,f.inputBuffer="")),e=null,g=null)})},t=function(a){a.state===f.noteState.WAITING?a.state=f.noteState.FAILED:a.state===f.noteState.HITTING&&(a.state=f.noteState.HITTINGFAILED),f.combo=0};this.startTime=Date.now(),this.dataXML=null,this.roll=null,this.player=null,this.settings={zeroEstimateSamples:16,videoId:"fQ_m5VLhqNg",dataFile:"data.utx",width:1120,height:630,hitPosition:.4,noteSize:50,speed:.5,rollYpos:.5,longLineHeight:150,lineHeight:120,screenPadding:30,bufferTextPosition:[.2,.8],currentLyricPosition:[.5,.25],nextLyricPosition:[.5,.3],kanaLyricPosition:[.5,.8],judges:[{name:"perfect",from:-50,to:50},{name:"great",from:-70,to:70},{name:"good",from:-100,to:100},{name:"bad",from:-1/0,to:150}],breakCombo:"bad",failureSuspension:100,initial:!1,correction:0,controlledCorrection:0,offset:0,volume:100,playbackQuality:"default",tableFile:"convert/romaji.xml"},this.zeroTime=0,this.zeroTimePad=0,this.currentTime=0,this.estimateSamples=[],this.estimatedZero=0,this.zeroCallFPS=0,Object.defineProperty(this,"now",{get:function(){return window.performance.now()}}),this.table=[],this.currentNoteIndex=null,this.inputBuffer="",this.currentLyricIndex=null,this.nextLyricIndex=null,this.combo=0,this.play=function(){f.player.playVideo(),setInterval(s,10)},this.hit=function(a,b,c){b||(b=f.now-f.zeroTime);var d=function(b,c){var e=f.roll[b],h="";h=b===f.currentNoteIndex?f.inputBuffer+a:a,c||(c=a);var i=f.table.filter(function(a){if(!g(a.before,h))return!1;if(!g(e.remainingText,a.after))return!1;if(a.next){var c;if(null!==(c=q(b))){var f=d(c,a.next);return f?!0:!1}return!1}return!0});if(0===i.length)return!1;var j={noteIndex:b,forcedHit:null},k=1/0,l=null;return i.forEach(function(a){a.before.length<k&&(k=a.before.length,l=a)}),j.appliedRule=l,f.settings.initial?(j.remainingText="",j.inputBuffer=""):h.length===l.before.length?(j.remainingText=e.remainingText.substr(l.after.length),j.inputBuffer="",l.next&&(j.forcedHit=l.next)):(j.remainingText=e.remainingText,j.inputBuffer=h),j},e=function(a){var c=f.roll[a.noteIndex];f.currentNoteIndex=a.noteIndex,""===a.remainingText?(c.state=f.noteState.CLEARED,c.remainingText="",f.inputBuffer="",f.currentNoteIndex=null):(c.state=f.noteState.HITTING,c.remainingText=a.remainingText,f.inputBuffer=a.inputBuffer),f.roll.forEach(function(a){"note"===a.type&&a.time<c.time&&(a.state===f.noteState.WAITING||a.state===f.noteState.HITTING)&&t(a)}),a.forcedHit&&f.hit(a.forcedHit,b,!0)};if(1===a.length){if(null!==f.currentNoteIndex){var h=d(f.currentNoteIndex);if(h)return void e(h)}var i=null,j=null,k=1/0;f.roll.forEach(function(a,c){if("note"===a.type&&c>f.currentNoteIndex&&a.state===f.noteState.WAITING&&Math.abs(a.time-b)<Math.abs(k)){var e=d(c);e&&(i=a,j=e,k=a.time-b)}});var l=k;if(null!==i){var m=null;if(f.settings.judges.some(function(a){return a.from<=l&&l<=a.to?(m=a.name,!0):!1}),c&&null===m&&(m=f.judges[f.judges.length-1].name),null!==m){if(null!==f.currentNoteIndex){var n=f.roll[f.currentNoteIndex];t(n)}e(j),m===f.settings.breakCombo&&(f.combo=0),f.combo++,v.onJudgement({judgement:{distance:l,judge:m,combo:f.combo}})}}}},this.getKanaLyric=function(a){if("undefined"==typeof a&&(a=f.currentLyricIndex),null===a)return null;for(var b="",c=a+1;c<f.roll.length;c++)if("note"===f.roll[c].type)b+=f.roll[c].text;else if("stop"===f.roll[c].type||"lyric"===f.roll[c].type)break;return b};for(var u in d)d.hasOwnProperty(u)&&(void 0===this.settings[u]?this.settings[u]=d[u]:"number"==typeof this.settings[u]?this.settings[u]=parseFloat(d[u],10):"string"==typeof this.settings[u]?this.settings[u]=d[u]:"boolean"==typeof this.settings[u]&&(this.settings[u]=Boolean(d[u])));this.correction=this.settings.correction+this.settings.controlledCorrection+1e3*this.settings.offset,this.zeroTimePad=this.correction-1e3*this.settings.offset,this.zeroTime=this.correction-1e3*this.settings.offset,this.DOM={wrap:c.css({width:this.settings.width+"px",height:this.settings.height+"px",margin:"0 auto",position:"relative"}),player:$("<div/>",{id:"youtyping-player"}).appendTo(c).css({width:this.settings.width+"px",height:this.settings.height+"px",display:"block","z-index":0}),screen:$("<canvas/>",{id:"youtyping-screen","data-paper-keepalive":"true",width:this.settings.width.toString(),height:this.settings.height.toString()}).appendTo(c).css({width:this.settings.width+"px",height:this.settings.height+"px",position:"absolute",top:0,left:0,"z-index":100})},this.screen=new e(document.getElementById("youtyping-screen"),this);var v=this.screen,w=["onPlayerStateChange","onHit","onJudgement","onLyricChange","onError"];w.forEach(function(a){"function"!=typeof v[a]&&(v[a]=function(){})}),$.when($.when(o(),$.Deferred(this.screen.setup).promise()).done(this.screen.load),p(),i()).done(this.screen.ready).fail(function(){a("ERROR: Initialization Failed...")})},e=function(b,c){var d=this,e=0;this.canvas=b,this.items={},this.setup=function(b){paper.setup(d.canvas),d.cover=new paper.Path.Rectangle(paper.view.bounds),d.cover.fillColor="black",d.cover.fillColor.alpha=.7,d.debugTexts=[];for(var f=0;5>f;f++){var g=d.debugTexts.push(new paper.PointText([20,20*(f+1)]));d.debugText=d.debugTexts[g-1],d.debugText.justification="left",d.debugText.fillColor="white"}d.bufferText=new paper.PointText({point:paper.view.bounds.bottomRight.multiply(c.settings.bufferTextPosition),content:"",fillColor:"white",justification:"left",fontSize:24}),d.currentLyric=new paper.PointText({point:paper.view.bounds.bottomRight.multiply(c.settings.currentLyricPosition),content:"",fillColor:"white",justification:"center",fontSize:36}),d.nextLyric=new paper.PointText({point:paper.view.bounds.bottomRight.multiply(c.settings.nextLyricPosition),content:"",fillColor:"white",justification:"center",fontSize:18}),d.kanaLyric=new paper.PointText({point:paper.view.bounds.bottomRight.multiply(c.settings.kanaLyricPosition),content:"",fillColor:"white",justification:"center",fontSize:24}),d.judgeEffects=new paper.Group,setInterval(function(){d.debugTexts[0].content="FPS: "+e,e=0,d.debugTexts[2].content="Zerocall FPS: "+c.zeroCallFPS,c.zeroCallFPS=0},1e3),a("Screen is Set."),b.resolve()},this.load=function(){var b=c.settings,e=c.now,f=b.width*(1-b.hitPosition)+b.noteSize+b.screenPadding,g=b.width*b.hitPosition+b.noteSize+b.screenPadding;try{c.roll.forEach(function(a){a.emergeTime=(b.speed*a.time-f)/b.speed,a.vanishTime=(b.speed*a.time+g)/b.speed}),a("Computed roll Parameters.")}catch(h){return a("ERROR: Computing roll Parameters Faild: "+h),-1}c.zeroTime=e,d.update(),d.hitCircle=new paper.Path.Circle({center:paper.view.bounds.bottomRight.multiply([b.hitPosition,b.rollYpos]),radius:b.noteSize,strokeWidth:1,strokeColor:"white"})},this.ready=function(){d.pressEnter=new paper.PointText({point:paper.view.bounds.bottomRight.multiply([.5,.8]),content:"Press enter or click here.",justification:"center",fontSize:45,fillColor:"white"});var b=function(a){("keydown"===a.type&&"enter"===a.key||"mousedown"===a.type)&&(d.pressEnter.remove(),paper.tool.onKeyDown=null,d.start())};paper.tool.onKeyDown=b,d.pressEnter.onMouseDown=b,a("Screen is Ready.")},this.start=function(){a("Starting game."),paper.view.onFrame=d.onFrame,c.play();var b=function(a){1===c.player.getPlayerState()&&"keydown"===a.type&&(a.preventDefault(),c.hit(a.key))};paper.tool.onKeyDown=b},this.update=function(){var a=c.settings,b=d.items,e=c.now,f=e-c.zeroTime;c.roll.forEach(function(d,e){var g=(d.time-f)*a.speed+a.width*a.hitPosition;if(e in b){if(f<d.emergeTime||d.vanishTime<f)return b[e].remove(),void delete b[e]}else{if(!(d.emergeTime<=f&&f<=d.vanishTime))return;b[e]=new paper.Group,"longline"===d.type&&(b[e].longLine=b[e].addChild(new paper.Path.Line({from:[g,a.rollYpos*a.height-a.longLineHeight/2],to:[g,a.rollYpos*a.height+a.longLineHeight/2],strokeColor:"white",strokeWidth:2}))),"line"===d.type&&(b[e].smallLine=b[e].addChild(new paper.Path.Line({from:[g,a.rollYpos*a.height-a.lineHeight/2],to:[g,a.rollYpos*a.height+a.lineHeight/2],strokeColor:"white",strokeWidth:1}))),"note"===d.type&&(b[e].note=b[e].addChild(new paper.Path.Circle({center:[g,a.rollYpos*a.height],radius:a.noteSize,strokeWidth:1,strokeColor:"#aaa"})),b[e].lyric=b[e].addChild(new paper.PointText({point:[g,a.rollYpos*a.height+a.noteSize+50],content:d.remainingText,fillColor:"white",justification:"center",fontSize:20,fontFamily:"sans-serif"}))),"stop"===d.type&&(b[e].orderStop=b[e].addChild(new paper.Path({segments:[[g,a.rollYpos*a.height-a.noteSize-30]],fillColor:"white"})),b[e].orderStop.lineBy([10,-10]),b[e].orderStop.lineBy([-20,0]),b[e].orderStop.closed=!0)}"longline"===d.type&&(b[e].position.x=g),"line"===d.type&&(b[e].position.x=g),"stop"===d.type&&(b[e].position.x=g),"note"===d.type&&(b[e].position.x=g,d.state===c.noteState.CLEARED?(b[e].note.visible=!1,b[e].lyric.visible=!1):(b[e].note.style={fillColor:d.state===c.noteState.WAITING||d.state===c.noteState.HITTING?"red":"#aaa"},b[e].note.opacity=d.state===c.noteState.FAILED||d.state===c.noteState.WAITING?1:.5,b[e].lyric.content=d.remainingText))})},this.onFrame=function(){1===c.player.getPlayerState()&&d.update(),d.debugTexts[1].content="Measured Zero: "+c.estimatedZero.toFixed(2),d.debugTexts[3].content="Active Objects: "+paper.project.activeLayer.children.length,d.debugTexts[4].content="Zero Time: "+c.zeroTime.toFixed(2),d.bufferText.content=c.inputBuffer,d.currentLyric.content=c.currentLyricIndex?c.roll[c.currentLyricIndex].text:"",d.nextLyric.content=c.nextLyricIndex?c.roll[c.nextLyricIndex].text:"",d.judgeEffects.children.forEach(function(a){a.controller.onFrame()}),e++},this.onPlayerStateChange=function(a){c.DOM.screen.css(a.data===YT.PlayerState.PLAYING?{cursor:"none"}:{cursor:"auto"})},this.onJudgement=function(a){var b=new f(a.judgement);b.item.controller=b,d.judgeEffects.addChild(b.item)};var f=function(a){var b=c.settings;switch(this.item=new paper.Group,this.judgeColor="",a.judge){case"perfect":this.judgeColor="yellow";break;case"great":this.judgeColor="#2d1";break;case"good":this.judgeColor="#19a";break;case"bad":this.judgeColor="#aaa"}this.judge=this.item.addChild(new paper.PointText({point:d.hitCircle.position.add([0,-b.noteSize-24]),content:a.judge,fillColor:this.judgeColor,justification:"center",fontSize:24,fontFamily:"sans-serif"})),this.combo=this.item.addChild(new paper.PointText({point:d.hitCircle.position.add([0,-b.noteSize]),content:a.combo,fillColor:"white",justification:"center",fontSize:15,fontFamily:"sans-serif"})),this.onFrame=function(){this.item.translate([0,-3]),this.item.opacity-=.02,this.item.opacity<0&&this.item.remove()}}};if("undefined"==typeof window.performance&&(window.performance={}),!window.performance.now){var f=Date.now();window.performance.now=function(){return Date.now()-f}}var g=function(a,b){return a.length<b.length?!1:a.substring(0,b.length)===b};return d}();
//# sourceMappingURL=youtyping.min.map