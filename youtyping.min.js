/* youtyping.js 06-03-2014 */

var YouTyping=function(){function a(a){var b=new Date,d=c(b.getHours(),2),e=c(b.getMinutes(),2),f=c(b.getSeconds(),2),g=c(b.getMilliseconds(),3);$("#debug").append("["+d+":"+e+":"+f+"."+g+"] "+a+"\n"),console.log(a)}function b(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function c(a,b){return a=a.toString(),a.length<b?c("0"+a,b):a}var d=function(c,d){var f,g=this,h=function(){f=$.Deferred(),a("Setting Player Up...");var b=document.createElement("script");b.src="https://www.youtube.com/iframe_api";var c=document.getElementsByTagName("script")[0];return c.parentNode.insertBefore(b,c),f.promise()};onYouTubeIframeAPIReady=function(){var c=g.settings;a("Player API is Ready."),"true"===b("sandbox")&&this.DOM.player.setAttribute("sandbox","allow-same-origin allow-scripts"),g.player=new YT.Player("youtyping-player",{height:c.height,width:c.width,videoId:c.videoId,playerVars:{rel:0,controls:0,showinfo:0,modestbranding:1,wmode:"opaque"},events:{onReady:j,onStateChange:k,onError:l}})};var i,j=function(){a("Player is Ready."),f.resolve()},k=function(b){switch(b.data){case YT.PlayerState.ENDED:a("Player Ended.");break;case YT.PlayerState.PLAYING:a("Player Started.");break;case YT.PlayerState.PAUSED:a("Player Paused.");break;case YT.PlayerState.BUFFERING:a("Player Buffering.");break;case YT.PlayerState.CUED:a("Player Cued.")}},l=function(b){switch(b.data){case 2:a("ERROR: The request contains an invalid parameter value. For example, this error occurs if you specify a video ID that does not have 11 characters, or if the video ID contains invalid characters, such as exclamation points or asterisks.");break;case 5:a("ERROR: The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred.");break;case 100:a("ERROR: The video requested was not found. This error occurs when a video has been removed (for any reason) or has been marked as private.");break;case 101:a("ERROR: The owner of the requested video does not allow it to be played in embedded players.");break;case 150:a("ERROR: The owner of the requested video does not allow it to be played in embedded players.")}f.reject()},m=function(){var b=g.settings;return i=$.Deferred(),$.ajax({url:b.score,type:"get",datatype:"xml",timeout:1e3,success:function(b){g.scoreXML=$(b).find("fumen").find("item"),a("Loaded XML File."),n(),i.resolve()},error:function(b,c,d){a("ERROR: XML File Loading Failed: "+d),i.reject()}}),i.promise()},n=function(){var b=g.settings,c=b.width-b.hitPosition+b.noteSize+b.screenPadding,d=b.hitPosition+b.noteSize+b.screenPadding;try{g.score=[],$(g.scoreXML).each(function(){var a={time:parseFloat($(this).attr("time")),type:$(this).attr("type")};$(this).attr("text")&&(a.text=$(this).attr("text")),g.score.push(a)}),g.score.forEach(function(a){a.emergeTime=(b.speed*a.time-c)/b.speed,a.vanishTime=(b.speed*a.time+d)/b.speed}),a("Computed score Parameters.")}catch(e){a("ERROR: Computing score Parameters Faild: "+e),i.reject()}};this.startTime=Date.now(),this.scoreXML=null,this.score=null,this.player=null,this.settings={zeroEstimateSamples:16,videoId:"fQ_m5VLhqNg",score:"data.utfx",width:1120,height:630,hitPosition:200,noteSize:50,speed:500,scoreYpos:.5,longLineHeight:150,lineHeight:120,screenPadding:30},this.zeroTime=0,this.zeroTimePad=0,this.currentTime=0,this.estimateSamples=[],this.estimatedZero=0,this.zeroCallFPS=0,this.play=function(){g.player.playVideo(),setInterval(function(){var a=g.player.getCurrentTime(),b=window.performance.now()||Date.now()-g.startTime;if(0===a)g.zeroTimePad=b;else if(g.currentTime!==a){g.currentTime=a,g.estimatedZero=b-1e3*g.currentTime,g.estimateSamples.push(g.estimatedZero),g.estimateSamples.length>g.settings.zeroEstimateSamples&&g.estimateSamples.shift();var c=g.estimateSamples.reduce(function(a,b){return a+b});g.zeroTimePad=c/g.estimateSamples.length,g.zeroCallFPS++}g.zeroTime=.9*(g.zeroTime-g.zeroTimePad)+g.zeroTimePad},10)};for(var o in d)this.settings[o]=void 0===this.settings[o]?d[o]:"number"==typeof this.settings[o]?parseInt(d[o],10):d[o];this.DOM={wrap:c.css({width:this.settings.width+"px",height:this.settings.height+"px",margin:"0 auto",position:"relative"}),player:$("<div/>",{id:"youtyping-player"}).appendTo(c).css({width:this.settings.width+"px",height:this.settings.height+"px",display:"block","z-index":0}),screen:$("<canvas/>",{id:"youtyping-screen","data-paper-keepalive":"true",width:this.settings.width.toString(),height:this.settings.height.toString()}).appendTo(c).css({width:this.settings.width+"px",height:this.settings.height+"px",position:"absolute",top:0,left:0,"z-index":100})},this.screen=new e(document.getElementById("youtyping-screen"),this);var p=h(),q=m(),r=$.Deferred(this.screen.setup).promise();$.when($.when(q,r).done(this.screen.load),p).done(this.screen.ready).fail(function(){a("ERROR: Initialization Failed...")})},e=function(b,c){var d=this,e=0;this.canvas=b,this.items={},this.setup=function(b){paper.setup(d.canvas),d.cover=new paper.Path.Rectangle(paper.view.bounds),d.cover.fillColor="black",d.cover.fillColor.alpha=.7,d.debugTexts=[];for(var f=0;5>f;f++){var g=d.debugTexts.push(new paper.PointText([20,20*(f+1)]));d.debugText=d.debugTexts[g-1],d.debugText.justification="left",d.debugText.fillColor="white"}setInterval(function(){d.debugTexts[0].content="FPS: "+e,e=0,d.debugTexts[2].content="Zerocall FPS: "+c.zeroCallFPS,c.zeroCallFPS=0},1e3),a("Screen is Set."),b.resolve()},this.load=function(){var a=c.settings,b=window.performance.now()||Date.now()-c.startTime;c.zeroTime=b,d.update(),this.hitCircle=new paper.Path.Circle({center:[a.hitPosition,a.scoreYpos*a.height],radius:a.noteSize,strokeWidth:1,strokeColor:"white"})},this.ready=function(){d.pressEnter=new paper.PointText({point:paper.view.bounds.bottomRight.multiply([.5,.8]),content:"Press enter.",justification:"center",fontSize:45,fillColor:"white"}),paper.tool.onKeyDown=function(a){"enter"===a.key&&(d.pressEnter.remove(),paper.tool.onKeyDown=null,d.start())},a("Screen is Ready.")},this.start=function(){a("Starting game."),paper.view.onFrame=function(){1===c.player.getPlayerState()&&d.update(),d.debugTexts[1].content="Measured Zero: "+c.estimatedZero.toFixed(2),d.debugTexts[3].content="Active Objects: "+paper.project.activeLayer.children.length,d.debugTexts[4].content="Zero Time: "+c.zeroTime.toFixed(2),e++},c.play()},this.update=function(){var a=c.settings,b=this.items,d=window.performance.now()||Date.now()-c.startTime,e=(d-c.zeroTime)/1e3;c.score.forEach(function(c,d){var f=(c.time-e)*a.speed+a.hitPosition;d in b?c.emergeTime>e||c.vanishTime<e?(b[d].remove(),delete b[d]):b[d].position.x=f:c.emergeTime<=e&&c.vanishTime>=e&&(b[d]=new paper.Group,"="===c.type&&b[d].addChild(new paper.Path.Line({from:[f,a.scoreYpos*a.height-a.longLineHeight/2],to:[f,a.scoreYpos*a.height+a.longLineHeight/2],strokeColor:"white",strokeWidth:2})),"-"===c.type&&b[d].addChild(new paper.Path.Line({from:[f,a.scoreYpos*a.height-a.lineHeight/2],to:[f,a.scoreYpos*a.height+a.lineHeight/2],strokeColor:"white",strokeWidth:1})),"+"===c.type&&(b[d].addChild(new paper.Path.Circle({center:[f,a.scoreYpos*a.height],radius:a.noteSize,strokeWidth:1,strokeColor:"#aaa",fillColor:"red"})),b[d].addChild(new paper.PointText({position:[f,a.scoreYpos*a.height+a.noteSize+50],content:c.text,fillColor:"white",justification:"center",fontSize:20,fontFamily:"sans-serif"}))))})}};return d}();
//# sourceMappingURL=youtyping.min.map