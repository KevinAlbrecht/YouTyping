/* youtyping.js 06-28-2014 */

!function(a){function b(a){var b=new Date,c=d(b.getHours(),2),e=d(b.getMinutes(),2),f=d(b.getSeconds(),2),g=d(b.getMilliseconds(),3);$("#debug").append("["+c+":"+e+":"+f+"."+g+"] "+a+"\n"),console.log(a)}function c(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function d(a,b){return a=a.toString(),a.length<b?d("0"+a,b):a}var e=function(a,d){var e=this,f=d.screen;this.noteState={WAITING:0,HITTING:1,CLEARED:2,HITTINGFAILED:3,FAILED:4},this.settings={zeroEstimateSamples:16,videoId:"fQ_m5VLhqNg",dataFile:"data.utx",tableFile:"convert/romaji.xml",width:1120,height:630,judges:[{name:"perfect",from:-50,to:50},{name:"great",from:-70,to:70},{name:"good",from:-100,to:100},{name:"bad",from:-1/0,to:150}],breakCombo:"bad",failureSuspension:100,initial:!1,correction:0,controlledCorrection:0,offset:0,volume:100,playbackQuality:"default"},this.startTime=Date.now(),this.dataXML=null,this.roll=null,this.player=null,this.zeroTime=0,this.zeroTimePad=0,this.currentTime=0,this.estimateSamples=[],this.estimatedZero=0,this.zeroCallFPS=0,Object.defineProperty(this,"now",{get:function(){return window.performance.now()}}),this.table=[],this.currentNoteIndex=null,this.inputBuffer="",this.currentLyricIndex=null,this.nextLyricIndex=null,this.combo=0,this.maxCombo=0,this.score=0,this.scorebook={};var g,i=function(){g=$.Deferred(),b("Setting Player Up...");var a=document.createElement("script");a.src="https://www.youtube.com/iframe_api";var c=document.getElementsByTagName("script")[0];return c.parentNode.insertBefore(a,c),g.promise()};window.onYouTubeIframeAPIReady=function(){var a=e.settings;b("Player API is Ready."),"true"===c("sandbox")&&this.DOM.player.setAttribute("sandbox","allow-same-origin allow-scripts"),e.player=new YT.Player("youtyping-player",{height:a.height,width:a.width,videoId:a.videoId,playerVars:{rel:0,start:a.offset,controls:0,showinfo:0,modestbranding:1,wmode:"opaque"},events:{onReady:l,onStateChange:m,onError:n}})};var j,k,l=function(){b("Player is Ready."),e.player.setVolume(e.settings.volume),e.player.setPlaybackQuality(e.settings.playbackQuality),g.resolve()},m=function(a){switch(f.onPlayerStateChange.call(f,a),a.data){case YT.PlayerState.ENDED:b("Player Ended.");break;case YT.PlayerState.PLAYING:b("Player Started.");break;case YT.PlayerState.PAUSED:b("Player Paused.");break;case YT.PlayerState.BUFFERING:b("Player Buffering.");break;case YT.PlayerState.CUED:b("Player Cued.")}},n=function(a){switch(a.data){case 2:b("ERROR: The request contains an invalid parameter value. For example, this error occurs if you specify a video ID that does not have 11 characters, or if the video ID contains invalid characters, such as exclamation points or asterisks.");break;case 5:b("ERROR: The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred.");break;case 100:b("ERROR: The video requested was not found. This error occurs when a video has been removed (for any reason) or has been marked as private.");break;case 101:b("ERROR: The owner of the requested video does not allow it to be played in embedded players.");break;case 150:b("ERROR: The owner of the requested video does not allow it to be played in embedded players.")}g.reject()},o=function(){return j=$.Deferred(),$.ajax({url:e.settings.dataFile,type:"get",datatype:"xml",timeout:1e3,success:function(a){e.dataXML=$(a).find("data").first();var c=e.dataXML.find("roll > item");e.roll=[];var d=null;$(c).each(function(){var a={time:1e3*parseFloat($(this).attr("time")),type:$(this).attr("type")};$(this).has("text")&&(a.text=a.remainingText=$(this).children("text").text()),"note"===a.type&&(a.state=e.noteState.WAITING,a.judgement=null,d=a),e.roll.push(a)}),e.lastNote=d,e.nextLyricIndex=r(-1),b("Loaded XML File."),j.resolve()},error:function(a,c,d){b("ERROR: XML File Loading Failed: "+d),j.reject()}}),j.promise()},p=function(){return k=$.Deferred(),$.ajax({url:e.settings.tableFile,type:"get",datatype:"xml",timeout:1e3,success:function(a){try{e.table=[],$(a).find("table").find("rule").each(function(a){if(e.table.push({before:$(this).attr("before"),after:$(this).attr("after"),next:$(this).attr("next")}),$(this).attr("next")&&1!==$(this).attr("next").length)throw"Rule "+a+": next string must be one character"}),b("Loaded Table File.")}catch(c){return b("ERROR: Table File Parsing Failed: "+c),void k.reject()}k.resolve()},error:function(a,c,d){b("ERROR: Table File Loading Failed: "+d),k.reject()}}),k.promise()},q=function(a){for(var b=null,c=a+1;c<e.roll.length;c++){var d=e.roll[c];if("stop"===d.type){b=null;break}if("note"===d.type){b=c;break}}return b},r=function(a){for(var b=null,c=a+1;c<e.roll.length;c++){var d=e.roll[c];if("lyric"===d.type){b=c;break}}return b},s=function(){var a=e.player.getCurrentTime(),b=e.now;if(a===e.settings.offset)e.zeroTimePad=b-1e3*e.settings.offset+e.correction,e.zeroTime=b-1e3*e.settings.offset+e.correction;else if(e.currentTime!==a&&a>e.settings.offset){e.currentTime=a,e.estimatedZero=b-1e3*e.currentTime,e.estimateSamples.push(e.estimatedZero),e.estimateSamples.length>e.settings.zeroEstimateSamples&&e.estimateSamples.shift();var c=e.estimateSamples.reduce(function(a,b){return a+b});e.zeroTimePad=c/e.estimateSamples.length+e.correction,e.zeroCallFPS++}e.zeroTime=.9*(e.zeroTime-e.zeroTimePad)+e.zeroTimePad;var d=b-e.zeroTime,f=null,g=null;e.roll.forEach(function(a,b){"note"===a.type&&a.time+e.settings.failureSuspension<d?(a.state===e.noteState.WAITING||a.state===e.noteState.HITTING)&&(f&&(t(f),g===e.currentNoteIndex&&(e.currentNoteIndex=null,e.inputBuffer="")),f=a,g=b):"lyric"===a.type&&a.time<d?e.currentLyricIndex<b&&(e.currentLyricIndex=b,e.nextLyricIndex=r(b)):"stop"===a.type&&a.time<d&&(e.currentLyricIndex<b&&(e.currentLyricIndex=null),f&&(t(f),g===e.currentNoteIndex&&(e.currentNoteIndex=null,e.inputBuffer="")),f=null,g=null)})},t=function(a){a.state===e.noteState.WAITING?(a.state=e.noteState.FAILED,a.judgement="neglect",e.scorebook.neglect++):a.state===e.noteState.HITTING&&(a.state=e.noteState.HITTINGFAILED,a.judgement="failed",e.scorebook.failed++),e.lastNote.state!==e.noteState.WAITING&&e.lastNote.state!==e.noteState.HITTING&&u(),e.combo=0},u=function(){f.onGameEnd()};this.play=function(){e.player.playVideo(),setInterval(s,10)},this.hit=function(a,b,c){b||(b=e.now-e.zeroTime);var d=function(b,c){var f=e.roll[b],g="";g=b===e.currentNoteIndex?e.inputBuffer+a:a,c||(c=a);var i=e.table.filter(function(a){if(!h(a.before,g))return!1;if(!h(f.remainingText,a.after))return!1;if(a.next){var c;if(null!==(c=q(b))){var e=d(c,a.next);return e?!0:!1}return!1}return!0});if(0===i.length)return!1;var j={noteIndex:b,forcedHit:null},k=1/0,l=null;return i.forEach(function(a){a.before.length<k&&(k=a.before.length,l=a)}),j.appliedRule=l,e.settings.initial?(j.remainingText="",j.inputBuffer=""):g.length===l.before.length?(j.remainingText=f.remainingText.substr(l.after.length),j.inputBuffer="",l.next&&(j.forcedHit=l.next)):(j.remainingText=f.remainingText,j.inputBuffer=g),j},g=function(a){var c=e.roll[a.noteIndex];e.currentNoteIndex=a.noteIndex,""===a.remainingText?(c.state=e.noteState.CLEARED,c.remainingText="",e.inputBuffer="",e.currentNoteIndex=null,e.scorebook[c.judgement]++):(c.state=e.noteState.HITTING,c.remainingText=a.remainingText,e.inputBuffer=a.inputBuffer),e.roll.forEach(function(a){"note"===a.type&&a.time<c.time&&(a.state===e.noteState.WAITING||a.state===e.noteState.HITTING)&&t(a)}),a.forcedHit&&e.hit(a.forcedHit,b,!0),e.lastNote.state!==e.noteState.WAITING&&e.lastNote.state!==e.noteState.HITTING&&u()};if(1===a.length){if(null!==e.currentNoteIndex){var i=d(e.currentNoteIndex);if(i)return void g(i)}var j=null,k=null,l=1/0;e.roll.forEach(function(a,c){if("note"===a.type&&c>e.currentNoteIndex&&a.state===e.noteState.WAITING&&Math.abs(a.time-b)<Math.abs(l)){var f=d(c);f&&(j=a,k=f,l=a.time-b)}});var m=l;if(null!==j){var n=null;if(e.settings.judges.some(function(a){return a.from<=m&&m<=a.to?(n=a.name,!0):!1}),c&&null===n&&(n=e.judges[e.judges.length-1].name),null!==n){if(null!==e.currentNoteIndex){var o=e.roll[e.currentNoteIndex];t(o)}j.judgement=n,g(k),n===e.settings.breakCombo&&(e.combo=0),e.combo++,e.combo>e.maxCombo&&(e.maxCombo=e.combo),f.onJudgement.call(f,{judgement:{distance:m,judge:n,combo:e.combo}})}}}},this.getKanaLyric=function(a){if("undefined"==typeof a&&(a=e.currentLyricIndex),null===a)return null;for(var b="",c=a+1;c<e.roll.length;c++)if("note"===e.roll[c].type)b+=e.roll[c].text;else if("stop"===e.roll[c].type||"lyric"===e.roll[c].type)break;return b};for(var v in d)d.hasOwnProperty(v)&&(void 0===this.settings[v]?this.settings[v]=d[v]:"number"==typeof this.settings[v]?this.settings[v]=parseFloat(d[v],10):"string"==typeof this.settings[v]?this.settings[v]=d[v]:"boolean"==typeof this.settings[v]&&(this.settings[v]=Boolean(d[v])));this.correction=this.settings.correction+this.settings.controlledCorrection+1e3*this.settings.offset,this.zeroTimePad=this.correction-1e3*this.settings.offset,this.zeroTime=this.correction-1e3*this.settings.offset;var w=["onResourceReady","onGameReady","onPlayerStateChange","onMiss","onHit","onJudgement","onNoteClear","onLyricChange","onScoreChange","onVideoEnd","onGameEnd","onError"];w.forEach(function(a){"function"!=typeof f[a]&&(f[a]=function(){})}),e.scorebook.failed=0,e.scorebook.neglect=0,this.settings.judges.forEach(function(a){e.scorebook[a.name]=0}),$.when($.when(o(),p()).done(f.onResourceReady),i()).done(f.onGameReady).fail(function(){b("ERROR: Initialization Failed...")})},f=function(a,c){var d=this,f=0;this.items={},this.settings={width:1120,height:630,hitPosition:.4,speed:.5,noteSize:50,lyricSize:20,rollYpos:.5,longLineHeight:150,lineHeight:120,screenPadding:30,bufferTextPosition:[.2,.8],currentLyricPosition:[.5,.25],nextLyricPosition:[.5,.3],kanaLyricPosition:[.5,.8],judgeColors:{perfect:"yellow",great:"#2d1",good:"#19a",bad:"#aaa",failed:"#a34",neglect:"#39a"}};var g={videoId:"fQ_m5VLhqNg",dataFile:"data.utx",tableFile:"convert/romaji.xml",initial:!1,correction:0,controlledCorrection:0,offset:0,volume:100,playbackQuality:"default",screen:d};this.initialize=function(){paper.setup(d.canvas),d.cover=new paper.Path.Rectangle(paper.view.bounds),d.cover.fillColor="black",d.cover.fillColor.alpha=.7,d.debugTexts=[];for(var a=0;5>a;a++){var e=d.debugTexts.push(new paper.PointText([20,20*(a+1)]));d.debugText=d.debugTexts[e-1],d.debugText.justification="left",d.debugText.fillColor="white"}d.bufferText=new paper.PointText({point:paper.view.bounds.bottomRight.multiply(c.bufferTextPosition),content:"",fillColor:"white",justification:"left",fontSize:24}),d.currentLyric=new paper.PointText({point:paper.view.bounds.bottomRight.multiply(c.currentLyricPosition),content:"",fillColor:"white",justification:"center",fontSize:36}),d.nextLyric=new paper.PointText({point:paper.view.bounds.bottomRight.multiply(c.nextLyricPosition),content:"",fillColor:"white",justification:"center",fontSize:18}),d.kanaLyric=new paper.PointText({point:paper.view.bounds.bottomRight.multiply(c.kanaLyricPosition),content:"",fillColor:"white",justification:"center",fontSize:24}),d.judgeEffects=new paper.Group,setInterval(function(){d.debugTexts[0].content="FPS: "+f,f=0,d.debugTexts[2].content="Zerocall FPS: "+k.zeroCallFPS,k.zeroCallFPS=0},1e3),b("Screen Initialized.")},this.onResourceReady=function(){var a=k.now,e=c.width*(1-c.hitPosition)+c.noteSize+c.screenPadding,f=c.width*c.hitPosition+c.noteSize+c.screenPadding;try{k.roll.forEach(function(a){a.emergeTime=(c.speed*a.time-e)/c.speed,a.vanishTime=(c.speed*a.time+f)/c.speed}),b("Computed roll Parameters.")}catch(g){return b("ERROR: Computing roll Parameters Faild: "+g),-1}k.zeroTime=a,d.update(),d.hitCircle=new paper.Path.Circle({center:paper.view.bounds.bottomRight.multiply([c.hitPosition,c.rollYpos]),radius:c.noteSize,strokeWidth:1,strokeColor:"white"})},this.onGameReady=function(){d.pressEnter=new paper.PointText({point:paper.view.bounds.bottomRight.multiply([.5,.8]),content:"Press enter or click here.",justification:"center",fontSize:45,fillColor:"white"});var a=function(a){("keydown"===a.type&&"enter"===a.key||"mousedown"===a.type)&&(d.pressEnter.remove(),paper.tool.onKeyDown=null,d.start())};paper.tool.onKeyDown=a,d.pressEnter.onMouseDown=a,b("Game is Ready.")},this.start=function(){b("Starting game."),paper.view.onFrame=d.onFrame,k.play();var a=function(a){1===k.player.getPlayerState()&&"keydown"===a.type&&(a.preventDefault(),k.hit(a.key))};paper.tool.onKeyDown=a},this.update=function(){var a=d.items,b=k.now,e=b-k.zeroTime;k.roll.forEach(function(b,d){var f=(b.time-e)*c.speed+c.width*c.hitPosition;if(d in a){if(e<b.emergeTime||b.vanishTime<e)return a[d].remove(),void delete a[d]}else{if(!(b.emergeTime<=e&&e<=b.vanishTime))return;a[d]=new paper.Group,"longline"===b.type&&(a[d].longLine=a[d].addChild(new paper.Path.Line({from:[f,c.rollYpos*c.height-c.longLineHeight/2],to:[f,c.rollYpos*c.height+c.longLineHeight/2],strokeColor:"white",strokeWidth:2}))),"line"===b.type&&(a[d].smallLine=a[d].addChild(new paper.Path.Line({from:[f,c.rollYpos*c.height-c.lineHeight/2],to:[f,c.rollYpos*c.height+c.lineHeight/2],strokeColor:"white",strokeWidth:1}))),"note"===b.type&&(a[d].note=a[d].addChild(new paper.Path.Circle({center:[f,c.rollYpos*c.height],radius:c.noteSize,strokeWidth:1,strokeColor:"#aaa"})),a[d].lyric=a[d].addChild(new paper.PointText({point:[f,c.rollYpos*c.height+c.noteSize+50],content:b.remainingText,fillColor:"white",justification:"center",fontSize:c.lyricSize,fontFamily:"sans-serif"}))),"stop"===b.type&&(a[d].orderStop=a[d].addChild(new paper.Path({segments:[[f,c.rollYpos*c.height-c.noteSize-30]],fillColor:"white"})),a[d].orderStop.lineBy([10,-10]),a[d].orderStop.lineBy([-20,0]),a[d].orderStop.closed=!0)}"longline"===b.type&&(a[d].position.x=f),"line"===b.type&&(a[d].position.x=f),"stop"===b.type&&(a[d].position.x=f),"note"===b.type&&(a[d].position.x=f,b.state===k.noteState.CLEARED?(a[d].note.visible=!1,a[d].lyric.visible=!1):(a[d].note.style={fillColor:b.state===k.noteState.WAITING||b.state===k.noteState.HITTING?"red":"#aaa"},a[d].note.opacity=b.state===k.noteState.FAILED||b.state===k.noteState.WAITING?1:.5,a[d].lyric.content=b.remainingText))})},this.onFrame=function(){1===k.player.getPlayerState()&&d.update(),d.debugTexts[1].content="Measured Zero: "+k.estimatedZero.toFixed(2),d.debugTexts[3].content="Active Objects: "+paper.project.activeLayer.children.length,d.debugTexts[4].content="Zero Time: "+k.zeroTime.toFixed(2),d.bufferText.content=k.inputBuffer,d.currentLyric.content=k.currentLyricIndex?k.roll[k.currentLyricIndex].text:"",d.nextLyric.content=k.nextLyricIndex?k.roll[k.nextLyricIndex].text:"",d.judgeEffects.children.forEach(function(a){a.controller.onFrame()}),f++},this.onPlayerStateChange=function(a){$(d.DOM.screen).css(a.data===YT.PlayerState.PLAYING?{cursor:"none"}:{cursor:"auto"})},this.onJudgement=function(a){var b=new h(a.judgement);b.item.controller=b,d.judgeEffects.addChild(b.item)};var h=function(a){this.item=new paper.Group,this.judgeColor=c.judgeColors[a.judge],this.judge=this.item.addChild(new paper.PointText({point:d.hitCircle.position.add([0,-c.noteSize-24]),content:a.judge,fillColor:this.judgeColor,justification:"center",fontSize:24,fontFamily:"sans-serif"})),this.combo=this.item.addChild(new paper.PointText({point:d.hitCircle.position.add([0,-c.noteSize]),content:a.combo,fillColor:"white",justification:"center",fontSize:15,fontFamily:"sans-serif"})),this.onFrame=function(){this.item.translate([0,-3]),this.item.opacity-=.02,this.item.opacity<0&&this.item.remove()}};this.onGameEnd=function(){b("Game Ended."),d.resultCover=new paper.Path.Rectangle(paper.view.bounds),d.resultCover.fillColor="#ddd",d.resultCover.fillColor.alpha=0,d.resultCover.onFrame=function(){this.fillColor.alpha+=.01,this.fillColor.alpha>=1&&(d.resultCover.onFrame=null,i())}};var i=function(){var a=paper.view.bounds.bottomRight;d.result=[],d.result.push(new paper.PointText({point:a.multiply([.2,0]).add([0,100]),content:"Result:",fillColor:"black",justification:"left",fontSize:48,fontFamily:"sans-serif"})),["perfect","great","good","bad","failed","neglect"].forEach(function(b,e){var f=new paper.Color(c.judgeColors[b]);f.brightness-=.3,f.saturation+=.2,d.result.push(new paper.PointText({point:a.multiply([.2,0]).add([0,40*e+180]),content:b+": "+k.scorebook[b],fillColor:f,justification:"left",fontSize:36,fontFamily:"sans-serif"}))}),d.result.push(new paper.PointText({point:a.multiply([.2,0]).add([0,450]),content:"Max Combo: "+k.maxCombo,fillColor:"black",justification:"left",fontSize:36,fontFamily:"sans-serif"}))};for(var j in c)c.hasOwnProperty(j)&&(void 0===this.settings[j]?this.settings[j]=c[j]:"number"==typeof this.settings[j]?this.settings[j]=parseFloat(c[j],10):"string"==typeof this.settings[j]?this.settings[j]=c[j]:"boolean"==typeof this.settings[j]&&(this.settings[j]=Boolean(c[j])));for(j in g)g.hasOwnProperty(j)&&"undefined"!=typeof this.settings[j]&&(g[j]=this.settings[j]);c=this.settings,this.DOM={wrap:a.css({width:this.settings.width+"px",height:this.settings.height+"px",margin:"0 auto",position:"relative"})[0],player:$("<div/>",{id:"youtyping-player"}).appendTo(a).css({width:this.settings.width+"px",height:this.settings.height+"px",display:"block","z-index":0})[0],screen:$("<canvas/>",{id:"youtyping-screen","data-paper-keepalive":"true",width:this.settings.width.toString(),height:this.settings.height.toString()}).appendTo(a).css({width:this.settings.width+"px",height:this.settings.height+"px",position:"absolute",top:0,left:0,"z-index":100})[0]},this.canvas=this.DOM.screen,g.width=this.settings.width,g.height=this.settings.height,this.youTyping=new e(this.DOM.player,g);var k=this.youTyping;this.initialize()};if("undefined"==typeof window.performance&&(window.performance={}),!window.performance.now){var g=Date.now();window.performance.now=function(){return Date.now()-g}}var h=function(a,b){return a.length<b.length?!1:a.substring(0,b.length)===b};a.YouTyping=e,a.Screen=f}("undefined"==typeof window?module.exports:window);
//# sourceMappingURL=youtyping.min.map