/* youtyping.js 28-05-2014 */
function setupPlayer(){setupPlayerDeferred=$.Deferred(),logTrace("Setting Player Up...");var a=document.createElement("script");a.src="https://www.youtube.com/iframe_api";var b=document.getElementsByTagName("script")[0];return b.parentNode.insertBefore(a,b),setupPlayerDeferred.promise()}function onYouTubeIframeAPIReady(){logTrace("Player API is Ready."),"true"==getParameterByName("sandbox")&&document.getElementById("player").setAttribute("sandbox","allow-same-origin allow-scripts"),player=new YT.Player("player",{height:setting.height,width:setting.width,videoId:setting.videoId,playerVars:{rel:0,controls:0,showinfo:0,modestbranding:1,wmode:"opaque"},events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange,onError:onPlayerError}})}function onPlayerReady(){logTrace("Player is Ready."),setupPlayerDeferred.resolve()}function onPlayerStateChange(a){switch(a.data){case YT.PlayerState.ENDED:logTrace("Player Ended.");break;case YT.PlayerState.PLAYING:logTrace("Player Started.");break;case YT.PlayerState.PAUSED:logTrace("Player Paused.");break;case YT.PlayerState.BUFFERING:logTrace("Player Buffering.");break;case YT.PlayerState.CUED:logTrace("Player Cued.")}}function onPlayerError(a){switch(a.data){case 2:logTrace("ERROR: The request contains an invalid parameter value. For example, this error occurs if you specify a video ID that does not have 11 characters, or if the video ID contains invalid characters, such as exclamation points or asterisks.");break;case 5:logTrace("ERROR: The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred.");break;case 100:logTrace("ERROR: The video requested was not found. This error occurs when a video has been removed (for any reason) or has been marked as private.");break;case 101:logTrace("ERROR: The owner of the requested video does not allow it to be played in embedded players.");break;case 150:logTrace("ERROR: The owner of the requested video does not allow it to be played in embedded players.")}setupPlayerDeferred.reject()}function loadUTFX(){return loadUTFXDeferred=$.Deferred(),$.ajax({url:setting.fumen,type:"get",datatype:"xml",timeout:1e3,success:function(a){fumenUTFX=$(a).find("fumen").find("item"),logTrace("Loaded UTFX File."),loadUTFXDeferred.resolve()},error:function(a,b,c){logTrace("ERROR: UTFX File Loading Failed: "+c),loadUTFXDeferred.reject()}}),loadUTFXDeferred.promise()}function logTrace(a){var b=new Date,c=pad(b.getHours(),2),d=pad(b.getMinutes(),2),e=pad(b.getSeconds(),2),f=pad(b.getMilliseconds(),3);$("#debug").append("["+c+":"+d+":"+e+"."+f+"] "+a+"\n"),console.log(a)}function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function pad(a,b){return a=a.toString(),a.length<b?pad("0"+a,b):a}var startTime=Date.now(),setting={zeroEstimateSamples:16,videoId:"fQ_m5VLhqNg",fumen:"data.utfx",width:1120,height:630,hitPosition:200,noteSize:50,speed:500,fumenYpos:.5,longLineHeight:150,lineHeight:120,screenPadding:30};for(var param in setting)getParameterByName(param)&&(setting[param]="number"==typeof setting[param]?parseInt(getParameterByName(param)):getParameterByName(param));var fumenUTFX,fumen=[];$.ajax("./don.svg").done(function(a){don=new paper.Symbol(paper.project.importSVG(a))}),$(document).ready(function(){logTrace("Document is Ready."),$("div#wrapper, #player, canvas#screen").css({width:setting.width+"px",height:setting.height+"px"});var a=setupPlayer(),b=loadUTFX(),c=$.Deferred(setupScreen).promise();$.when($.when(b,c).done(loadScreen),a).done(startScreen).fail(function(){logTrace("ERROR: Initialization Failed...")})});var player,items={},Screen=function(a){function b(){var a=window.performance.now()||Date.now()-startTime,b=(a-c)/1e3;fumen.forEach(function(a,c){var d=(a.time-b)*setting.speed+setting.hitPosition;c in items?a.emergeTime>b||a.vanishTime<b?(items[c].remove(),delete items[c]):items[c].position.x=d:a.emergeTime<=b&&a.vanishTime>=b&&(items[c]=new paper.Group,"="==a.type&&items[c].addChild(new paper.Path.Line({from:[d,setting.fumenYpos*setting.height-setting.longLineHeight/2],to:[d,setting.fumenYpos*setting.height+setting.longLineHeight/2],strokeColor:"white",strokeWidth:2})),"-"==a.type&&items[c].addChild(new paper.Path.Line({from:[d,setting.fumenYpos*setting.height-setting.lineHeight/2],to:[d,setting.fumenYpos*setting.height+setting.lineHeight/2],strokeColor:"white",strokeWidth:1})),"+"==a.type&&(items[c].addChild(don.place([d,setting.fumenYpos*setting.height]).scale(setting.noteSize/50*2)),items[c].addChild(new paper.PointText({position:[d,setting.fumenYpos*setting.height+setting.noteSize+50],content:a.text,fillColor:"white",justification:"center",fontSize:20,fontFamily:"sans-serif"}))))})}var c=0,d=0,e=0;this.setup=function(b){this.canvas=a,paper.setup(this.canvas),this.cover=new paper.Path.Rectangle(paper.view.bounds),this.cover.fillColor="black",this.cover.fillColor.alpha=.7,this.debugTexts=[];for(var c=0;5>c;c++){var f=this.debugTexts.push(new paper.PointText([20,20*(c+1)]));this.debugText=debugTexts[f-1],this.debugText.justification="left",this.debugText.fillColor="white"}setInterval(function(){this.debugTexts[0].content="FPS: "+d,d=0,this.debugTexts[2].content="Zerocall FPS: "+e,e=0},1e3),logTrace("Screen is Set."),b.resolve()},this.load=function(){this.computeParameters(),b(),hitCircle=new paper.Path.Circle({center:[setting.hitPosition,setting.fumenYpos*setting.height],radius:setting.noteSize,strokeWidth:1,strokeColor:"white"}),logTrace("Screen is Ready.")}};