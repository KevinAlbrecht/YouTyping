/* youtyping.js 24-05-2014 */
function setupPlayer(){setupPlayerDeferred=$.Deferred(),logTrace("Setting Player Up...");var a=document.createElement("script");a.src="https://www.youtube.com/iframe_api";var b=document.getElementsByTagName("script")[0];return b.parentNode.insertBefore(a,b),setupPlayerDeferred.promise()}function onYouTubeIframeAPIReady(){logTrace("Player API is Ready."),"true"==getParameterByName("sandbox")&&document.getElementById("player").setAttribute("sandbox","allow-same-origin allow-scripts"),player=new YT.Player("player",{height:setting.height,width:setting.width,videoId:setting.videoId,playerVars:{rel:0,controls:0,showinfo:0,modestbranding:1,wmode:"opaque"},events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange,onError:onPlayerError}})}function onPlayerReady(){logTrace("Player is Ready."),setupPlayerDeferred.resolve()}function onPlayerStateChange(a){switch(a.data){case YT.PlayerState.ENDED:logTrace("Player Ended.");break;case YT.PlayerState.PLAYING:logTrace("Player Started.");break;case YT.PlayerState.PAUSED:logTrace("Player Paused.");break;case YT.PlayerState.BUFFERING:logTrace("Player Buffering.");break;case YT.PlayerState.CUED:logTrace("Player Cued.")}}function onPlayerError(a){switch(a.data){case 2:logTrace("ERROR: The request contains an invalid parameter value. For example, this error occurs if you specify a video ID that does not have 11 characters, or if the video ID contains invalid characters, such as exclamation points or asterisks.");break;case 5:logTrace("ERROR: The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred.");break;case 100:logTrace("ERROR: The video requested was not found. This error occurs when a video has been removed (for any reason) or has been marked as private.");break;case 101:logTrace("ERROR: The owner of the requested video does not allow it to be played in embedded players.");break;case 150:logTrace("ERROR: The owner of the requested video does not allow it to be played in embedded players.")}setupPlayerDeferred.reject()}function loadUTFX(){return loadUTFXDeferred=$.Deferred(),$.ajax({url:setting.fumen,type:"get",datatype:"xml",timeout:1e3,success:function(a){fumenUTFX=$(a).find("fumen").find("item"),logTrace("Loaded UTFX File."),loadUTFXDeferred.resolve()},error:function(a,b,c){logTrace("ERROR: UTFX File Loading Failed: "+c),loadUTFXDeferred.reject()}}),loadUTFXDeferred.promise()}function logTrace(a){var b=new Date,c=pad(b.getHours(),2),d=pad(b.getMinutes(),2),e=pad(b.getSeconds(),2),f=pad(b.getMilliseconds(),3);$("#debug").append("["+c+":"+d+":"+e+"."+f+"] "+a+"\n"),console.log(a)}function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function pad(a,b){return a=a.toString(),a.length<b?pad("0"+a,b):a}function computeParameters(){var a=setting.width-setting.hitPosition+setting.noteSize+setting.screenPadding,b=setting.hitPosition+setting.noteSize+setting.screenPadding;try{$(fumenUTFX).each(function(){var a={time:parseFloat($(this).attr("time")),type:$(this).attr("type")};$(this).attr("text")&&(a.text=$(this).attr("text")),fumen.push(a)}),fumen.forEach(function(c){c.emergeTime=(setting.speed*c.time-a)/setting.speed,c.vanishTime=(setting.speed*c.time+b)/setting.speed}),logTrace("Computed Fumen Parameters.")}catch(c){logTrace("ERROR: Computing Fumen Parameters Faild: "+c),loadUTFXDeferred.reject()}}function updateScreen(){var a=window.performance.now()||Date.now()-startTime,b=(a-zeroTime)/1e3;fumen.forEach(function(a,c){var d=(a.time-b)*setting.speed+setting.hitPosition;c in items?a.emergeTime>b||a.vanishTime<b?(items[c].remove(),delete items[c]):items[c].position.x=d:a.emergeTime<=b&&a.vanishTime>=b&&(items[c]=new paper.Group,"="==a.type&&items[c].addChild(new paper.Path.Line({from:[d,setting.fumenYpos*setting.height-setting.longLineHeight/2],to:[d,setting.fumenYpos*setting.height+setting.longLineHeight/2],strokeColor:"white",strokeWidth:2})),"-"==a.type&&items[c].addChild(new paper.Path.Line({from:[d,setting.fumenYpos*setting.height-setting.lineHeight/2],to:[d,setting.fumenYpos*setting.height+setting.lineHeight/2],strokeColor:"white",strokeWidth:1})),"+"==a.type&&(items[c].addChild(don.place([d,setting.fumenYpos*setting.height]).scale(setting.noteSize/50*2)),items[c].addChild(new paper.PointText({position:[d,setting.fumenYpos*setting.height+setting.noteSize+50],content:a.text,fillColor:"white",justification:"center",fontSize:20,fontFamily:"sans-serif"}))))})}var startTime=Date.now(),setting={zeroEstimateSamples:16,videoId:"fQ_m5VLhqNg",fumen:"data.utfx",width:1120,height:630,hitPosition:200,noteSize:50,speed:500,fumenYpos:.5,longLineHeight:150,lineHeight:120,screenPadding:30};for(var param in setting)getParameterByName(param)&&(setting[param]="number"==typeof setting[param]?parseInt(getParameterByName(param)):getParameterByName(param));var fumenUTFX,fumen=[];$.ajax("./don.svg").done(function(a){don=new paper.Symbol(paper.project.importSVG(a))}),$(document).ready(function(){logTrace("Document is Ready."),$("div#wrapper, #player, canvas#screen").css({width:setting.width+"px",height:setting.height+"px"});var a=setupPlayer(),b=loadUTFX(),c=$.Deferred(setupScreen).promise();$.when($.when(b,c).done(loadScreen),a).done(startScreen).fail(function(){logTrace("ERROR: Initialization Failed...")})});var player,zeroTime=0,zeroTimePad=0,currentTime=0,estimateSamples=[],fps=0,zerocallfps=0,items={},setupScreen=function(a){var b=document.getElementById("screen");paper.setup(b),cover=new paper.Path.Rectangle(paper.view.bounds),cover.fillColor="black",cover.fillColor.alpha=.7,debugTexts=[];for(var c=0;5>c;c++){var d=debugTexts.push(new paper.PointText([20,20*(c+1)]));debugText=debugTexts[d-1],debugText.justification="left",debugText.fillColor="white"}setInterval(function(){debugTexts[0].content="FPS: "+fps,fps=0,debugTexts[2].content="Zerocall FPS: "+zerocallfps,zerocallfps=0},1e3),logTrace("Screen is Set."),a.resolve()},loadScreen=function(){computeParameters(),updateScreen(),hitCircle=new paper.Path.Circle({center:[setting.hitPosition,setting.fumenYpos*setting.height],radius:setting.noteSize,strokeWidth:1,strokeColor:"white"}),logTrace("Screen is Ready.")},startScreen=function(){player.playVideo(),paper.view.onFrame=function(){1==player.getPlayerState()&&updateScreen(),debugTexts[3].content="Active Objects: "+paper.project.activeLayer.children.length,debugTexts[4].content="Zero Time: "+zeroTime.toFixed(2),fps++},setInterval(function(){if(currentTime!=player.getCurrentTime()){var a=window.performance.now()||Date.now()-startTime;currentTime=player.getCurrentTime(),runTime=currentTime;var b=a-1e3*currentTime;debugTexts[1].content="Measured Zero: "+b.toFixed(2),estimateSamples.push(b),estimateSamples.length>setting.zeroEstimateSamples&&estimateSamples.shift();var c=estimateSamples.reduce(function(a,b){return a+b});zeroTimePad=c/estimateSamples.length,zerocallfps++}zeroTime=.9*(zeroTime-zeroTimePad)+zeroTimePad},10)};