!function(a){function b(a){var b=new Date,c=d(b.getHours(),2),e=d(b.getMinutes(),2),f=d(b.getSeconds(),2),g=d(b.getMilliseconds(),3);$("#debug").append("["+c+":"+e+":"+f+"."+g+"] "+a+"\n"),console.log(a)}function c(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function d(a,b){return a=a.toString(),a.length<b?d("0"+a,b):a}function e(a,b){if(!a){if(b=b||"Assertion failed","undefined"!=typeof Error)throw new Error(b);throw b}}var f=function(a,d){var f=this,g=d.screen;this.noteState={WAITING:0,HITTING:1,CLEARED:2,HITTINGFAILED:3,FAILED:4},this.itemType={LINE:0,LONGLINE:1,NOTE:2,LYRIC:3,STOP:4},this.settings={zeroEstimateSamples:16,videoId:"fQ_m5VLhqNg",dataFile:"data.utx",tableFile:"convert/romaji.xml",width:1120,height:630,judges:[{name:"perfect",from:-50,to:50,weight:1},{name:"great",from:-70,to:70,weight:.5},{name:"good",from:-100,to:100,weight:.25},{name:"bad",from:-1/0,to:150,weight:0}],breakCombo:"bad",failureSuspension:100,initial:!1,correction:0,controlledCorrection:0,offset:0,videoStop:0,volume:100,playbackQuality:"default"};for(var i in d)d.hasOwnProperty(i)&&(void 0===this.settings[i]?this.settings[i]=d[i]:"number"==typeof this.settings[i]?this.settings[i]=parseFloat(d[i],10):"string"==typeof this.settings[i]?this.settings[i]=d[i]:"boolean"==typeof this.settings[i]&&(this.settings[i]=Boolean(d[i])));this.dataXML=null,this.roll=null,this.player=null,Object.defineProperty(this,"now",{get:function(){return window.performance.now()}}),this.table=[];var j,k=function(){j=$.Deferred(),b("Setting Player Up...");var a=document.createElement("script");a.src="https://www.youtube.com/iframe_api";var c=document.getElementsByTagName("script")[0];return c.parentNode.insertBefore(a,c),j.promise()};window.onYouTubeIframeAPIReady=function(){var a=f.settings;b("Player API is Ready."),"true"===c("sandbox")&&this.DOM.player.setAttribute("sandbox","allow-same-origin allow-scripts"),f.player=new YT.Player("youtyping-player",{height:a.height,width:a.width,videoId:a.videoId,playerVars:{rel:0,start:a.offset,controls:0,showinfo:0,modestbranding:1,wmode:"opaque"},events:{onReady:n,onStateChange:o,onError:p}})};var l,m,n=function(){b("Player is Ready."),f.player.setVolume(f.settings.volume),f.player.setPlaybackQuality(f.settings.playbackQuality),f.player.playVideo(),f.player.pauseVideo(),j.resolve()},o=function(a){switch(g.onPlayerStateChange.call(g,a),a.data){case YT.PlayerState.ENDED:b("Player Ended.");break;case YT.PlayerState.PLAYING:b("Player Started."),f.isPlayingGame&&(f.estimateSamples=[]);break;case YT.PlayerState.PAUSED:b("Player Paused.");break;case YT.PlayerState.BUFFERING:b("Player Buffering.");break;case YT.PlayerState.CUED:b("Player Cued.")}},p=function(a){switch(a.data){case 2:b("ERROR: The request contains an invalid parameter value. For example, this error occurs if you specify a video ID that does not have 11 characters, or if the video ID contains invalid characters, such as exclamation points or asterisks.");break;case 5:b("ERROR: The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred.");break;case 100:b("ERROR: The video requested was not found. This error occurs when a video has been removed (for any reason) or has been marked as private.");break;case 101:b("ERROR: The owner of the requested video does not allow it to be played in embedded players.");break;case 150:b("ERROR: The owner of the requested video does not allow it to be played in embedded players.")}j.reject()},q=function(){return l=$.Deferred(),$.ajax({url:f.settings.dataFile,type:"get",datatype:"xml",timeout:1e4,success:function(a){f.dataXML=$(a).find("data").first(),r(),b("Loaded XML File."),l.resolve()},error:function(a,c,d){b("ERROR: XML File Loading Failed: "+d),l.reject()}}),l.promise()},r=function(){var a=f.dataXML.find("roll > item");f.roll=[];var c=null,d=0;$(a).each(function(){var a={time:1e3*parseFloat($(this).attr("time")),type:$(this).attr("type").mapsTo({line:f.itemType.LINE,longline:f.itemType.LONGLINE,note:f.itemType.NOTE,lyric:f.itemType.LYRIC,stop:f.itemType.STOP})};return null===a.type?(b("ERROR: Unknown item type "+$(this).attr("type")),void l.reject()):($(this).has("text")&&(a.text=a.remainingText=$(this).children("text").text()),a.type===f.itemType.NOTE&&(a.state=f.noteState.WAITING,a.judgement=null,c=a,50>d&&d++,f.totalCombo+=d),void f.roll.push(a))}),f.lastNote=c,f.nextLyricIndex=w(-1)},s=function(){return m=$.Deferred(),$.ajax({url:f.settings.tableFile,type:"get",datatype:"xml",timeout:1e4,success:function(a){try{f.table=[],$(a).find("table").find("rule").each(function(a){if(f.table.push({before:$(this).attr("before"),after:$(this).attr("after"),next:$(this).attr("next")}),$(this).attr("next")&&1!==$(this).attr("next").length)throw"Rule "+a+": next string must be one character"}),b("Loaded Table File.")}catch(c){return b("ERROR: Table File Parsing Failed: "+c),void m.reject()}m.resolve()},error:function(a,c,d){b("ERROR: Table File Loading Failed: "+d),m.reject()}}),m.promise()},t=function(){var a=0;f.roll.forEach(function(b){if(b.type===f.itemType.NOTE){var c=u(b.text);if(null===c)throw new Error("Note "+b.text+" cannot be romanized");b.romaji=c,b.weight=c.length,a+=b.weight}}),f.totalWeight=a},u=function(a){var b=1/0,c=0,d=null;if(f.table.forEach(function(e){var f=null;f=e.next?(e.before.length-1)/e.after.length:e.before.length/e.after.length,h(a,e.after)&&(!e.next||a.length>e.next.length)&&(b>f||b===f&&c<e.after.length)&&(b=f,c=e.after.length,d=e)}),null===d)return null;e(a.length>=d.after.length);var g=a.slice(d.after.length);if(0===g.length)return d.before;var i=u(g,d.next);return null===i?null:d.before+i},v=function(a){for(var b=null,c=a+1;c<f.roll.length;c++){var d=f.roll[c];if(d.type===f.itemType.STOP){b=null;break}if(d.type===f.itemType.NOTE){b=c;break}}return b},w=function(a){for(var b=null,c=a+1;c<f.roll.length;c++){var d=f.roll[c];if(d.type===f.itemType.LYRIC){b=c;break}}return b},x=function(){var a=f.now,b=f.player.getCurrentTime(),c=f.player.getPlayerState();if(c===YT.PlayerState.PLAYING){if(f.currentTime!==b&&b>f.settings.offset){f.currentTime=b,f.estimatedZero=a-1e3*f.currentTime,f.estimateSamples.push(f.estimatedZero),f.estimateSamples.length>f.settings.zeroEstimateSamples&&f.estimateSamples.shift();var d=f.estimateSamples.reduce(function(a,b){return a+b});f.zeroTimePad=d/f.estimateSamples.length+f.correction,0!==f.settings.videoStop&&b>f.settings.videoStop&&f.player.stopVideo(),f.zeroCallFPS++}f.time=a-f.zeroTime,f.zeroTime=.9*(f.zeroTime-f.zeroTimePad)+f.zeroTimePad}else c===YT.PlayerState.ENDED||(f.zeroTime=f.zeroTimePad=a-1e3*f.settings.offset+f.correction-f.time);var e=f.time,g=null,h=null;f.roll.forEach(function(a,b){a.type===f.itemType.NOTE&&a.time+f.settings.failureSuspension<e?(a.state===f.noteState.WAITING||a.state===f.noteState.HITTING)&&(g&&(y(g),h===f.currentNoteIndex&&(f.currentNoteIndex=null,f.inputBuffer="")),g=a,h=b):a.type===f.itemType.LYRIC&&a.time<e?f.currentLyricIndex<b&&(f.currentLyricIndex=b,f.nextLyricIndex=w(b)):a.type===f.itemType.STOP&&a.time<e&&(f.currentLyricIndex<b&&(f.currentLyricIndex=null),g&&(y(g),h===f.currentNoteIndex&&(f.currentNoteIndex=null,f.inputBuffer="")),g=null,h=null)})},y=function(a){a.state===f.noteState.WAITING?(a.state=f.noteState.FAILED,a.judgement="neglect",f.scorebook.neglect++):a.state===f.noteState.HITTING&&(a.state=f.noteState.HITTINGFAILED,f.scorebook.failed[a.judgement]++),f.lastNote.state!==f.noteState.WAITING&&f.lastNote.state!==f.noteState.HITTING&&z(),f.combo=0},z=function(){f.isPlayingGame=!1,f.highScore<=f.score&&(f.highScore=f.score,f.highScoreReplay=f.replay),localStorage.YouTyping=JSON.stringify({highScore:f.highScore,highScoreReplay:f.highScoreReplay}),g.onGameEnd()},A=function(){return 0===f.replay.length?null:f.replay[f.replay.length-1]},B=function(){var a=0;f.roll.forEach(function(b){if(b.type===f.itemType.NOTE&&b.judgement){var c=null;f.settings.judges.forEach(function(a){a.name===b.judgement&&(c=a.weight)}),null!==c&&(a+=b.state===f.noteState.CLEARED?b.weight*c:b.weight*c*.5)}}),f.score=10*Math.floor(7e4*a/f.totalWeight+3e4*f.scoredCombo/f.totalCombo)};this.play=function(){f.player.playVideo(),f.player.seekTo(f.settings.offset),f.isPlayingGame=!0,f.gameLoopId=setInterval(x,10),setTimeout(function(){f.player.getPlayerState()===YT.PlayerState.BUFFERING&&f.player.seekTo(f.settings.offset)},3e3)},this.hit=function(a,b,c){b||(b=f.now-f.zeroTime);var d=function(b,c){var e=f.roll[b],g="";g=b===f.currentNoteIndex?f.inputBuffer+a:a,c||(c=a);var i=f.table.filter(function(a){if(!h(a.before,g))return!1;if(!h(e.remainingText,a.after))return!1;if(a.next){var c;if(null!==(c=v(b))){var f=d(c,a.next);return f?!0:!1}return!1}return!0});if(0===i.length)return!1;var j={noteIndex:b,forcedHit:null},k=1/0,l=null;return i.forEach(function(a){a.before.length<k&&(k=a.before.length,l=a)}),j.appliedRule=l,f.settings.initial?(j.remainingText="",j.inputBuffer=""):g.length===l.before.length?(j.remainingText=e.remainingText.substr(l.after.length),j.inputBuffer="",l.next&&(j.forcedHit=l.next)):(j.remainingText=e.remainingText,j.inputBuffer=g),j},e=function(a){var c=f.roll[a.noteIndex];f.currentNoteIndex=a.noteIndex,""===a.remainingText?(c.state=f.noteState.CLEARED,c.remainingText="",f.inputBuffer="",f.currentNoteIndex=null,f.scorebook.cleared[c.judgement]++):(c.state=f.noteState.HITTING,c.remainingText=a.remainingText,f.inputBuffer=a.inputBuffer),f.roll.forEach(function(a){a.type===f.itemType.NOTE&&a.time<c.time&&(a.state===f.noteState.WAITING||a.state===f.noteState.HITTING)&&y(a)}),a.forcedHit&&f.hit(a.forcedHit,b,!0),f.lastNote.state!==f.noteState.WAITING&&f.lastNote.state!==f.noteState.HITTING&&z()};if(1===a.length){var i=A();if(!(i&&b<i.time)){if(f.replay.push({time:b,key:a}),null!==f.currentNoteIndex){var j=d(f.currentNoteIndex);if(j)return e(j),void B()}var k=f.settings.judges[f.settings.judges.length-1],l=null,m=null,n=1/0;f.roll.forEach(function(a,e){if(a.type===f.itemType.NOTE){var g=a.time-b;if((c||k.from<=g&&g<=k.to)&&e>f.currentNoteIndex&&a.state===f.noteState.WAITING&&Math.abs(g)<Math.abs(n)){var h=d(e);h&&(l=a,m=h,n=g)}}});var o=n;if(null!==l){var p=null;if(f.settings.judges.some(function(a){return a.from<=o&&o<=a.to?(p=a.name,!0):!1}),c&&null===p&&(p=f.judges[f.judges.length-1].name),null!==p){if(null!==f.currentNoteIndex){var q=f.roll[f.currentNoteIndex];y(q)}l.judgement=p,p===f.settings.breakCombo&&(f.combo=0),e(m),f.combo++,f.combo>f.maxCombo&&(f.maxCombo=f.combo),f.scoredCombo+=f.combo>50?50:f.combo,B(),g.onJudgement.call(g,{judgement:{distance:o,judge:p,combo:f.combo},noteIndex:m})}}}}},this.reset=function(){clearInterval(f.gameLoopId),f.initialize(),r(),f.isPlayingGame=!1,f.player.pauseVideo(),f.player.seekTo(f.settings.offset)},this.getKanaLyric=function(a){if("undefined"==typeof a&&(a=f.currentLyricIndex),null===a)return null;for(var b="",c=a+1;c<f.roll.length;c++)if(f.roll[c].type===f.itemType.NOTE)b+=f.roll[c].text;else if(f.roll[c].type===f.itemType.STOP||f.roll[c].type===f.itemType.LYRIC)break;return b},f.totalWeight=0,f.totalCombo=0,this.initialize=function(){f.zeroTime=0,f.zeroTimePad=0,f.currentTime=0,f.estimateSamples=[],f.estimatedZero=0,f.zeroCallFPS=0,f.correction=f.settings.correction+f.settings.controlledCorrection+1e3*f.settings.offset,f.zeroTimePad=f.correction-1e3*f.settings.offset,f.zeroTime=f.correction-1e3*f.settings.offset,f.time=0,f.currentNoteIndex=null,f.inputBuffer="",f.currentLyricIndex=null,f.nextLyricIndex=null,f.isPlayingGame=!1,f.combo=0,f.maxCombo=0,f.score=0,f.scoredCombo=0,f.replay=[],f.scorebook={},f.scorebook.failed={},f.scorebook.cleared={},f.scorebook.neglect=0,f.settings.judges.forEach(function(a){f.scorebook.failed[a.name]=0,f.scorebook.cleared[a.name]=0});var a={};void 0!==window.localStorage&&void 0!==window.localStorage.YouTyping&&(a=JSON.parse(window.localStorage.YouTyping)),f.highScore=a.highScore||0,f.highScoreReplay=a.highScoreReplay||[];var b=["onResourceReady","onGameReady","onPlayerStateChange","onMiss","onHit","onJudgement","onNoteClear","onLyricChange","onScoreChange","onVideoEnd","onGameEnd","onError"];b.forEach(function(a){"function"!=typeof g[a]&&(g[a]=function(){})})},this.initialize(),$.when($.when(q(),s()).done(t,g.onResourceReady),k()).done(g.onGameReady).fail(function(){b("ERROR: Initialization Failed...")})};if("undefined"==typeof window.performance&&(window.performance={}),!window.performance.now){var g=Date.now();window.performance.now=function(){return Date.now()-g}}var h=function(a,b){return a.length<b.length?!1:a.substring(0,b.length)===b};String.prototype.mapsTo=function(a){for(var b in a)if(a.hasOwnProperty(b)&&this.valueOf()===b)return a[b];return null},a.YouTyping=f}("undefined"==typeof window?module.exports:window);
//# sourceMappingURL=youtyping.min.map