!function(a){function b(a){var b=new Date,c=d(b.getHours(),2),e=d(b.getMinutes(),2),f=d(b.getSeconds(),2),g=d(b.getMilliseconds(),3);$("#debug").append("["+c+":"+e+":"+f+"."+g+"] "+a+"\n"),console.log(a)}function c(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function d(a,b){return a=a.toString(),a.length<b?d("0"+a,b):a}var e=function(a,d){var e=this,f=d.screen;this.noteState={WAITING:0,HITTING:1,CLEARED:2,HITTINGFAILED:3,FAILED:4},this.settings={zeroEstimateSamples:16,videoId:"fQ_m5VLhqNg",dataFile:"data.utx",tableFile:"convert/romaji.xml",width:1120,height:630,judges:[{name:"perfect",from:-50,to:50},{name:"great",from:-70,to:70},{name:"good",from:-100,to:100},{name:"bad",from:-1/0,to:150}],breakCombo:"bad",failureSuspension:100,initial:!1,correction:0,controlledCorrection:0,offset:0,volume:100,playbackQuality:"default"};for(var h in d)d.hasOwnProperty(h)&&(void 0===this.settings[h]?this.settings[h]=d[h]:"number"==typeof this.settings[h]?this.settings[h]=parseFloat(d[h],10):"string"==typeof this.settings[h]?this.settings[h]=d[h]:"boolean"==typeof this.settings[h]&&(this.settings[h]=Boolean(d[h])));this.dataXML=null,this.roll=null,this.player=null,Object.defineProperty(this,"now",{get:function(){return window.performance.now()}}),this.table=[];var i,j=function(){i=$.Deferred(),b("Setting Player Up...");var a=document.createElement("script");a.src="https://www.youtube.com/iframe_api";var c=document.getElementsByTagName("script")[0];return c.parentNode.insertBefore(a,c),i.promise()};window.onYouTubeIframeAPIReady=function(){var a=e.settings;b("Player API is Ready."),"true"===c("sandbox")&&this.DOM.player.setAttribute("sandbox","allow-same-origin allow-scripts"),e.player=new YT.Player("youtyping-player",{height:a.height,width:a.width,videoId:a.videoId,playerVars:{rel:0,start:a.offset,controls:0,showinfo:0,modestbranding:1,wmode:"opaque"},events:{onReady:m,onStateChange:n,onError:o}})};var k,l,m=function(){b("Player is Ready."),e.player.setVolume(e.settings.volume),e.player.setPlaybackQuality(e.settings.playbackQuality),i.resolve()},n=function(a){switch(f.onPlayerStateChange.call(f,a),a.data){case YT.PlayerState.ENDED:b("Player Ended.");break;case YT.PlayerState.PLAYING:b("Player Started."),e.isPlayingGame&&(e.estimateSamples=[]);break;case YT.PlayerState.PAUSED:b("Player Paused.");break;case YT.PlayerState.BUFFERING:b("Player Buffering.");break;case YT.PlayerState.CUED:b("Player Cued.")}},o=function(a){switch(a.data){case 2:b("ERROR: The request contains an invalid parameter value. For example, this error occurs if you specify a video ID that does not have 11 characters, or if the video ID contains invalid characters, such as exclamation points or asterisks.");break;case 5:b("ERROR: The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred.");break;case 100:b("ERROR: The video requested was not found. This error occurs when a video has been removed (for any reason) or has been marked as private.");break;case 101:b("ERROR: The owner of the requested video does not allow it to be played in embedded players.");break;case 150:b("ERROR: The owner of the requested video does not allow it to be played in embedded players.")}i.reject()},p=function(){return k=$.Deferred(),$.ajax({url:e.settings.dataFile,type:"get",datatype:"xml",timeout:1e4,success:function(a){e.dataXML=$(a).find("data").first(),q(),b("Loaded XML File."),k.resolve()},error:function(a,c,d){b("ERROR: XML File Loading Failed: "+d),k.reject()}}),k.promise()},q=function(){var a=e.dataXML.find("roll > item");e.roll=[];var b=null;$(a).each(function(){var a={time:1e3*parseFloat($(this).attr("time")),type:$(this).attr("type")};$(this).has("text")&&(a.text=a.remainingText=$(this).children("text").text()),"note"===a.type&&(a.state=e.noteState.WAITING,a.judgement=null,b=a),e.roll.push(a)}),e.lastNote=b,e.nextLyricIndex=t(-1)},r=function(){return l=$.Deferred(),$.ajax({url:e.settings.tableFile,type:"get",datatype:"xml",timeout:1e4,success:function(a){try{e.table=[],$(a).find("table").find("rule").each(function(a){if(e.table.push({before:$(this).attr("before"),after:$(this).attr("after"),next:$(this).attr("next")}),$(this).attr("next")&&1!==$(this).attr("next").length)throw"Rule "+a+": next string must be one character"}),b("Loaded Table File.")}catch(c){return b("ERROR: Table File Parsing Failed: "+c),void l.reject()}l.resolve()},error:function(a,c,d){b("ERROR: Table File Loading Failed: "+d),l.reject()}}),l.promise()},s=function(a){for(var b=null,c=a+1;c<e.roll.length;c++){var d=e.roll[c];if("stop"===d.type){b=null;break}if("note"===d.type){b=c;break}}return b},t=function(a){for(var b=null,c=a+1;c<e.roll.length;c++){var d=e.roll[c];if("lyric"===d.type){b=c;break}}return b},u=function(){var a=e.player.getCurrentTime(),b=e.now;if(e.player.getPlayerState()===YT.PlayerState.PLAYING){if(e.currentTime!==a&&a>e.settings.offset){e.currentTime=a,e.estimatedZero=b-1e3*e.currentTime,e.estimateSamples.push(e.estimatedZero),e.estimateSamples.length>e.settings.zeroEstimateSamples&&e.estimateSamples.shift();var c=e.estimateSamples.reduce(function(a,b){return a+b});e.zeroTimePad=c/e.estimateSamples.length+e.correction,e.zeroCallFPS++}e.time=b-e.zeroTime,e.zeroTime=.9*(e.zeroTime-e.zeroTimePad)+e.zeroTimePad}else e.zeroTime=e.zeroTimePad=b-1e3*e.settings.offset+e.correction-e.time;var d=e.time,f=null,g=null;e.roll.forEach(function(a,b){"note"===a.type&&a.time+e.settings.failureSuspension<d?(a.state===e.noteState.WAITING||a.state===e.noteState.HITTING)&&(f&&(v(f),g===e.currentNoteIndex&&(e.currentNoteIndex=null,e.inputBuffer="")),f=a,g=b):"lyric"===a.type&&a.time<d?e.currentLyricIndex<b&&(e.currentLyricIndex=b,e.nextLyricIndex=t(b)):"stop"===a.type&&a.time<d&&(e.currentLyricIndex<b&&(e.currentLyricIndex=null),f&&(v(f),g===e.currentNoteIndex&&(e.currentNoteIndex=null,e.inputBuffer="")),f=null,g=null)})},v=function(a){a.state===e.noteState.WAITING?(a.state=e.noteState.FAILED,a.judgement="neglect",e.scorebook.neglect++):a.state===e.noteState.HITTING&&(a.state=e.noteState.HITTINGFAILED,a.judgement="failed",e.scorebook.failed++),e.lastNote.state!==e.noteState.WAITING&&e.lastNote.state!==e.noteState.HITTING&&w(),e.combo=0},w=function(){e.isPlayingGame=!1,f.onGameEnd()},x=function(){return 0===e.replay.length?null:e.replay[e.replay.length-1]};this.play=function(){e.player.playVideo(),e.isPlayingGame=!0,e.gameLoopId=setInterval(u,10)},this.hit=function(a,b,c){b||(b=e.now-e.zeroTime);var d=function(b,c){var f=e.roll[b],h="";h=b===e.currentNoteIndex?e.inputBuffer+a:a,c||(c=a);var i=e.table.filter(function(a){if(!g(a.before,h))return!1;if(!g(f.remainingText,a.after))return!1;if(a.next){var c;if(null!==(c=s(b))){var e=d(c,a.next);return e?!0:!1}return!1}return!0});if(0===i.length)return!1;var j={noteIndex:b,forcedHit:null},k=1/0,l=null;return i.forEach(function(a){a.before.length<k&&(k=a.before.length,l=a)}),j.appliedRule=l,e.settings.initial?(j.remainingText="",j.inputBuffer=""):h.length===l.before.length?(j.remainingText=f.remainingText.substr(l.after.length),j.inputBuffer="",l.next&&(j.forcedHit=l.next)):(j.remainingText=f.remainingText,j.inputBuffer=h),j},h=function(a){var c=e.roll[a.noteIndex];e.currentNoteIndex=a.noteIndex,""===a.remainingText?(c.state=e.noteState.CLEARED,c.remainingText="",e.inputBuffer="",e.currentNoteIndex=null,e.scorebook[c.judgement]++):(c.state=e.noteState.HITTING,c.remainingText=a.remainingText,e.inputBuffer=a.inputBuffer),e.roll.forEach(function(a){"note"===a.type&&a.time<c.time&&(a.state===e.noteState.WAITING||a.state===e.noteState.HITTING)&&v(a)}),a.forcedHit&&e.hit(a.forcedHit,b,!0),e.lastNote.state!==e.noteState.WAITING&&e.lastNote.state!==e.noteState.HITTING&&w()};if(1===a.length){var i=x();if(!(i&&b<i.time)){if(e.replay.push({time:b,key:a}),null!==e.currentNoteIndex){var j=d(e.currentNoteIndex);if(j)return void h(j)}var k=null,l=null,m=1/0;e.roll.forEach(function(a,c){if("note"===a.type&&c>e.currentNoteIndex&&a.state===e.noteState.WAITING&&Math.abs(a.time-b)<Math.abs(m)){var f=d(c);f&&(k=a,l=f,m=a.time-b)}});var n=m;if(null!==k){var o=null;if(e.settings.judges.some(function(a){return a.from<=n&&n<=a.to?(o=a.name,!0):!1}),c&&null===o&&(o=e.judges[e.judges.length-1].name),null!==o){if(null!==e.currentNoteIndex){var p=e.roll[e.currentNoteIndex];v(p)}k.judgement=o,h(l),o===e.settings.breakCombo&&(e.combo=0),e.combo++,e.combo>e.maxCombo&&(e.maxCombo=e.combo),f.onJudgement.call(f,{judgement:{distance:n,judge:o,combo:e.combo}})}}}}},this.reset=function(){clearInterval(e.gameLoopId),e.initialize(),q(),e.isPlayingGame=!1,e.player.pauseVideo(),e.player.seekTo(e.settings.offset)},this.getKanaLyric=function(a){if("undefined"==typeof a&&(a=e.currentLyricIndex),null===a)return null;for(var b="",c=a+1;c<e.roll.length;c++)if("note"===e.roll[c].type)b+=e.roll[c].text;else if("stop"===e.roll[c].type||"lyric"===e.roll[c].type)break;return b},this.initialize=function(){e.zeroTime=0,e.zeroTimePad=0,e.currentTime=0,e.estimateSamples=[],e.estimatedZero=0,e.zeroCallFPS=0,e.correction=e.settings.correction+e.settings.controlledCorrection+1e3*e.settings.offset,e.zeroTimePad=e.correction-1e3*e.settings.offset,e.zeroTime=e.correction-1e3*e.settings.offset,e.time=0,e.currentNoteIndex=null,e.inputBuffer="",e.currentLyricIndex=null,e.nextLyricIndex=null,e.isPlayingGame=!1,e.combo=0,e.maxCombo=0,e.score=0,e.replay=[],e.scorebook={},e.scorebook.failed=0,e.scorebook.neglect=0,e.settings.judges.forEach(function(a){e.scorebook[a.name]=0});var a=["onResourceReady","onGameReady","onPlayerStateChange","onMiss","onHit","onJudgement","onNoteClear","onLyricChange","onScoreChange","onVideoEnd","onGameEnd","onError"];a.forEach(function(a){"function"!=typeof f[a]&&(f[a]=function(){})})},this.initialize(),$.when($.when(p(),r()).done(f.onResourceReady),j()).done(f.onGameReady).fail(function(){b("ERROR: Initialization Failed...")})};if("undefined"==typeof window.performance&&(window.performance={}),!window.performance.now){var f=Date.now();window.performance.now=function(){return Date.now()-f}}var g=function(a,b){return a.length<b.length?!1:a.substring(0,b.length)===b};a.YouTyping=e}("undefined"==typeof window?module.exports:window);
//# sourceMappingURL=youtyping.min.map