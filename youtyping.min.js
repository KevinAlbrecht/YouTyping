/* youtyping.js 05-30-2014 */
var YouTyping=function(){function a(a){var b=new Date,d=c(b.getHours(),2),e=c(b.getMinutes(),2),f=c(b.getSeconds(),2),g=c(b.getMilliseconds(),3);$("#debug").append("["+d+":"+e+":"+f+"."+g+"] "+a+"\n"),console.log(a)}function b(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function c(a,b){return a=a.toString(),a.length<b?c("0"+a,b):a}var d=function(c,d){function e(){m=$.Deferred(),a("Setting Player Up...");var b=document.createElement("script");b.src="https://www.youtube.com/iframe_api";var c=document.getElementsByTagName("script")[0];return c.parentNode.insertBefore(b,c),m.promise()}function g(){a("Player is Ready."),m.resolve()}function h(b){switch(b.data){case YT.PlayerState.ENDED:a("Player Ended.");break;case YT.PlayerState.PLAYING:a("Player Started.");break;case YT.PlayerState.PAUSED:a("Player Paused.");break;case YT.PlayerState.BUFFERING:a("Player Buffering.");break;case YT.PlayerState.CUED:a("Player Cued.")}}function i(b){switch(b.data){case 2:a("ERROR: The request contains an invalid parameter value. For example, this error occurs if you specify a video ID that does not have 11 characters, or if the video ID contains invalid characters, such as exclamation points or asterisks.");break;case 5:a("ERROR: The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred.");break;case 100:a("ERROR: The video requested was not found. This error occurs when a video has been removed (for any reason) or has been marked as private.");break;case 101:a("ERROR: The owner of the requested video does not allow it to be played in embedded players.");break;case 150:a("ERROR: The owner of the requested video does not allow it to be played in embedded players.")}m.reject()}function j(){var b=k.settings;return n=$.Deferred(),$.ajax({url:b.score,type:"get",datatype:"xml",timeout:1e3,success:function(b){k.scoreXML=$(b).find("fumen").find("item"),a("Loaded XML File."),n.resolve()},error:function(b,c,d){a("ERROR: XML File Loading Failed: "+d),n.reject()}}),n.promise()}var k=this;this.startTime=Date.now(),this.settings={zeroEstimateSamples:16,videoId:"fQ_m5VLhqNg",score:"data.utfx",width:1120,height:630,hitPosition:200,noteSize:50,speed:500,scoreYpos:.5,longLineHeight:150,lineHeight:120,screenPadding:30};for(var l in d)this.settings[l]=void 0===this.settings[l]?d[l]:"number"==typeof this.settings[l]?parseInt(d[l]):d[l];this.scoreXML=null,this.score=null,this.player=null;var m;onYouTubeIframeAPIReady=function(){var c=k.settings;a("Player API is Ready."),"true"==b("sandbox")&&this.DOM.player.setAttribute("sandbox","allow-same-origin allow-scripts"),k.player=new YT.Player("youtyping-player",{height:c.height,width:c.width,videoId:c.videoId,playerVars:{rel:0,controls:0,showinfo:0,modestbranding:1,wmode:"opaque"},events:{onReady:g,onStateChange:h,onError:i}})};var n;this.computeParameters=function(){var b=this.settings,c=b.width-b.hitPosition+b.noteSize+b.screenPadding,d=b.hitPosition+b.noteSize+b.screenPadding;try{this.score=[],$(this.scoreXML).each(function(){var a={time:parseFloat($(this).attr("time")),type:$(this).attr("type")};$(this).attr("text")&&(a.text=$(this).attr("text")),k.score.push(a)}),this.score.forEach(function(a){a.emergeTime=(b.speed*a.time-c)/b.speed,a.vanishTime=(b.speed*a.time+d)/b.speed}),a("Computed score Parameters.")}catch(e){a("ERROR: Computing score Parameters Faild: "+e),n.reject()}},this.DOM={wrap:c,player:$("<div/>",{id:"youtyping-player"}).appendTo(c),screen:$("<canvas/>",{id:"youtyping-screen","data-paper-keepalive":"true",width:this.settings.width.toString(),height:this.settings.height.toString()}).appendTo(c)},$(this.DOM.wrap).css({width:this.settings.width+"px",height:this.settings.height+"px",margin:"0 auto",position:"relative"}),$(this.DOM.player).css({width:this.settings.width+"px",height:this.settings.height+"px",display:"block","z-index":0}),$(this.DOM.screen).css({width:this.settings.width+"px",height:this.settings.height+"px",position:"absolute",top:0,left:0,"z-index":100}),this.screen=new f(document.getElementById("youtyping-screen"),this);var o=e(),p=j(),q=$.Deferred(this.screen.setup).promise();$.when($.when(p,q).done(this.screen.load),o).done(this.screen.start).fail(function(){a("ERROR: Initialization Failed...")})},e={},f=function(b,c){var d=this,f=0,g=0,h=0,i=[],j=0,k=0;this.canvas=b,this.setup=function(c){d.canvas=b,paper.setup(d.canvas),d.cover=new paper.Path.Rectangle(paper.view.bounds),d.cover.fillColor="black",d.cover.fillColor.alpha=.7,d.debugTexts=[];for(var e=0;5>e;e++){var f=d.debugTexts.push(new paper.PointText([20,20*(e+1)]));d.debugText=d.debugTexts[f-1],d.debugText.justification="left",d.debugText.fillColor="white"}setInterval(function(){d.debugTexts[0].content="FPS: "+j,j=0,d.debugTexts[2].content="Zerocall FPS: "+k,k=0},1e3),a("Screen is Set."),c.resolve()},this.load=function(){var b=c.settings;c.computeParameters(),d.update(),this.hitCircle=new paper.Path.Circle({center:[b.hitPosition,b.scoreYpos*b.height],radius:b.noteSize,strokeWidth:1,strokeColor:"white"}),a("Screen is Ready.")},this.start=function(){var a=c.player;a.playVideo(),paper.view.onFrame=function(){1==a.getPlayerState()&&d.update(),d.debugTexts[3].content="Active Objects: "+paper.project.activeLayer.children.length,d.debugTexts[4].content="Zero Time: "+f.toFixed(2),j++},setInterval(function(){if(h!=a.getCurrentTime()){var b=window.performance.now()||Date.now()-this.youTyping.startTime;h=a.getCurrentTime(),runTime=h;var e=b-1e3*h;d.debugTexts[1].content="Measured Zero: "+e.toFixed(2),i.push(e),i.length>c.settings.zeroEstimateSamples&&i.shift();var j=i.reduce(function(a,b){return a+b});g=j/i.length,k++}f=.9*(f-g)+g},10)},this.update=function(){var a=c.settings,b=window.performance.now()||Date.now()-this.youTyping.startTime,d=(b-f)/1e3;c.score.forEach(function(b,c){var f=(b.time-d)*a.speed+a.hitPosition;c in e?b.emergeTime>d||b.vanishTime<d?(e[c].remove(),delete e[c]):e[c].position.x=f:b.emergeTime<=d&&b.vanishTime>=d&&(e[c]=new paper.Group,"="===b.type&&e[c].addChild(new paper.Path.Line({from:[f,a.scoreYpos*a.height-a.longLineHeight/2],to:[f,a.scoreYpos*a.height+a.longLineHeight/2],strokeColor:"white",strokeWidth:2})),"-"===b.type&&e[c].addChild(new paper.Path.Line({from:[f,a.scoreYpos*a.height-a.lineHeight/2],to:[f,a.scoreYpos*a.height+a.lineHeight/2],strokeColor:"white",strokeWidth:1})),"+"===b.type&&(e[c].addChild(new paper.Path.Circle({center:[f,a.scoreYpos*a.height],radius:a.noteSize,strokeWidth:1,strokeColor:"#aaa",fillColor:"red"})),e[c].addChild(new paper.PointText({position:[f,a.scoreYpos*a.height+a.noteSize+50],content:b.text,fillColor:"white",justification:"center",fontSize:20,fontFamily:"sans-serif"}))))})}};return d}();