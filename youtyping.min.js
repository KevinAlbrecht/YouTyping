/* youtyping.js 06-08-2014 */

var YouTyping=function(){function a(a){var b=new Date,d=c(b.getHours(),2),e=c(b.getMinutes(),2),f=c(b.getSeconds(),2),g=c(b.getMilliseconds(),3);$("#debug").append("["+d+":"+e+":"+f+"."+g+"] "+a+"\n"),console.log(a)}function b(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function c(a,b){return a=a.toString(),a.length<b?c("0"+a,b):a}var d=function(c,d){var f=this;this.noteState={WAITING:0,HITTING:1,CLEARED:2,FAILED:3};var g,h=function(){g=$.Deferred(),a("Setting Player Up...");var b=document.createElement("script");b.src="https://www.youtube.com/iframe_api";var c=document.getElementsByTagName("script")[0];return c.parentNode.insertBefore(b,c),g.promise()};onYouTubeIframeAPIReady=function(){var c=f.settings;a("Player API is Ready."),"true"===b("sandbox")&&this.DOM.player.setAttribute("sandbox","allow-same-origin allow-scripts"),f.player=new YT.Player("youtyping-player",{height:c.height,width:c.width,videoId:c.videoId,playerVars:{rel:0,controls:0,showinfo:0,modestbranding:1,wmode:"opaque"},events:{onReady:j,onStateChange:k,onError:l}})};var i,j=function(){a("Player is Ready."),g.resolve()},k=function(b){switch(b.data){case YT.PlayerState.ENDED:a("Player Ended.");break;case YT.PlayerState.PLAYING:a("Player Started.");break;case YT.PlayerState.PAUSED:a("Player Paused.");break;case YT.PlayerState.BUFFERING:a("Player Buffering.");break;case YT.PlayerState.CUED:a("Player Cued.")}},l=function(b){switch(b.data){case 2:a("ERROR: The request contains an invalid parameter value. For example, this error occurs if you specify a video ID that does not have 11 characters, or if the video ID contains invalid characters, such as exclamation points or asterisks.");break;case 5:a("ERROR: The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred.");break;case 100:a("ERROR: The video requested was not found. This error occurs when a video has been removed (for any reason) or has been marked as private.");break;case 101:a("ERROR: The owner of the requested video does not allow it to be played in embedded players.");break;case 150:a("ERROR: The owner of the requested video does not allow it to be played in embedded players.")}g.reject()},m=function(){var b=f.settings;return i=$.Deferred(),$.ajax({url:b.score,type:"get",datatype:"xml",timeout:1e3,success:function(b){f.scoreXML=$(b).find("fumen").find("item"),a("Loaded XML File."),f.score=[],$(f.scoreXML).each(function(){var a={time:1e3*parseFloat($(this).attr("time")),type:$(this).attr("type")};$(this).attr("text")&&(a.text=$(this).attr("text")),"+"===a.type&&(a.state=f.noteState.WAITING),f.score.push(a)}),i.resolve()},error:function(b,c,d){a("ERROR: XML File Loading Failed: "+d),i.reject()}}),i.promise()};this.startTime=Date.now(),this.scoreXML=null,this.score=null,this.player=null,this.settings={zeroEstimateSamples:16,videoId:"fQ_m5VLhqNg",score:"data.utfx",width:1120,height:630,hitPosition:200,noteSize:50,speed:.5,scoreYpos:.5,longLineHeight:150,lineHeight:120,screenPadding:30,judges:{perfect:{from:-30,to:30},great:{from:-50,to:50},good:{from:-70,to:70}}},this.zeroTime=0,this.zeroTimePad=0,this.currentTime=0,this.estimateSamples=[],this.estimatedZero=0,this.zeroCallFPS=0,Object.defineProperty(this,"now",{get:function(){return window.performance.now()}}),this.play=function(){f.player.playVideo(),setInterval(function(){var a=f.player.getCurrentTime(),b=f.now;if(0===a)f.zeroTimePad=b,f.zeroTime=b;else if(f.currentTime!==a){f.currentTime=a,f.estimatedZero=b-1e3*f.currentTime,f.estimateSamples.push(f.estimatedZero),f.estimateSamples.length>f.settings.zeroEstimateSamples&&f.estimateSamples.shift();var c=f.estimateSamples.reduce(function(a,b){return a+b});f.zeroTimePad=c/f.estimateSamples.length,f.zeroCallFPS++}f.zeroTime=.9*(f.zeroTime-f.zeroTimePad)+f.zeroTimePad},10)},this.hit=function(a,b){b||(b=f.now);var c=b-f.zeroTime,d=null,e=1/0;f.score.forEach(function(a){"+"===a.type&&a.state===f.noteState.WAITING&&Math.abs(c-a.time)<Math.abs(e)&&(d=a,e=a.time-c)});var g=e;if(null!==d){var h=null;for(var i in f.settings.judges)if(f.settings.judges.hasOwnProperty(i)){var j=f.settings.judges[i];if(j.from<=g&&g<=j.to){h=i;break}}null!==h&&(d.state=f.noteState.CLEARED,console.log(g,h))}};for(var n in d)d.hasOwnProperty(n)&&(this.settings[n]=void 0===this.settings[n]?d[n]:"number"==typeof this.settings[n]?parseInt(d[n],10):d[n]);this.DOM={wrap:c.css({width:this.settings.width+"px",height:this.settings.height+"px",margin:"0 auto",position:"relative"}),player:$("<div/>",{id:"youtyping-player"}).appendTo(c).css({width:this.settings.width+"px",height:this.settings.height+"px",display:"block","z-index":0}),screen:$("<canvas/>",{id:"youtyping-screen","data-paper-keepalive":"true",width:this.settings.width.toString(),height:this.settings.height.toString()}).appendTo(c).css({width:this.settings.width+"px",height:this.settings.height+"px",position:"absolute",top:0,left:0,"z-index":100})},this.screen=new e(document.getElementById("youtyping-screen"),this),$.when($.when(m(),$.Deferred(this.screen.setup).promise()).done(this.screen.load),h()).done(this.screen.ready).fail(function(){a("ERROR: Initialization Failed...")})},e=function(b,c){var d=this,e=0;this.canvas=b,this.items={},this.setup=function(b){paper.setup(d.canvas),d.cover=new paper.Path.Rectangle(paper.view.bounds),d.cover.fillColor="black",d.cover.fillColor.alpha=.7,d.debugTexts=[];for(var f=0;5>f;f++){var g=d.debugTexts.push(new paper.PointText([20,20*(f+1)]));d.debugText=d.debugTexts[g-1],d.debugText.justification="left",d.debugText.fillColor="white"}setInterval(function(){d.debugTexts[0].content="FPS: "+e,e=0,d.debugTexts[2].content="Zerocall FPS: "+c.zeroCallFPS,c.zeroCallFPS=0},1e3),a("Screen is Set."),b.resolve()},this.load=function(){var b=c.settings,e=c.now,f=b.width-b.hitPosition+b.noteSize+b.screenPadding,g=b.hitPosition+b.noteSize+b.screenPadding;try{c.score.forEach(function(a){a.emergeTime=(b.speed*a.time-f)/b.speed,a.vanishTime=(b.speed*a.time+g)/b.speed}),a("Computed score Parameters.")}catch(h){return a("ERROR: Computing score Parameters Faild: "+h),-1}c.zeroTime=e,d.update(),this.hitCircle=new paper.Path.Circle({center:[b.hitPosition,b.scoreYpos*b.height],radius:b.noteSize,strokeWidth:1,strokeColor:"white"})},this.ready=function(){d.pressEnter=new paper.PointText({point:paper.view.bounds.bottomRight.multiply([.5,.8]),content:"Press enter or click.",justification:"center",fontSize:45,fillColor:"white"});var b=function(a){("keydown"===a.type&&"enter"===a.key||"mousedown"===a.type)&&(d.pressEnter.remove(),paper.tool.onKeyDown=null,d.start())};paper.tool.onKeyDown=b,d.pressEnter.onMouseDown=b,a("Screen is Ready.")},this.start=function(){a("Starting game."),paper.view.onFrame=function(){1===c.player.getPlayerState()&&d.update(),d.debugTexts[1].content="Measured Zero: "+c.estimatedZero.toFixed(2),d.debugTexts[3].content="Active Objects: "+paper.project.activeLayer.children.length,d.debugTexts[4].content="Zero Time: "+c.zeroTime.toFixed(2),e++},c.play();var b=function(a){1===c.player.getPlayerState()&&"keydown"===a.type&&c.hit(a.key)};paper.tool.onKeyDown=b};var f=function(a,b,e){var f=d.items,g=c.settings;f[b]&&f[b].remove(),f[b]=new paper.Group,"="===a.type&&f[b].addChild(new paper.Path.Line({from:[e,g.scoreYpos*g.height-g.longLineHeight/2],to:[e,g.scoreYpos*g.height+g.longLineHeight/2],strokeColor:"white",strokeWidth:2})),"-"===a.type&&f[b].addChild(new paper.Path.Line({from:[e,g.scoreYpos*g.height-g.lineHeight/2],to:[e,g.scoreYpos*g.height+g.lineHeight/2],strokeColor:"white",strokeWidth:1})),"+"===a.type&&(a.state===c.noteState.WAITING?(f[b].addChild(new paper.Path.Circle({center:[e,g.scoreYpos*g.height],radius:g.noteSize,strokeWidth:1,strokeColor:"#aaa",fillColor:"red"})),f[b].addChild(new paper.PointText({position:[e,g.scoreYpos*g.height+g.noteSize+50],content:a.text,fillColor:"white",justification:"center",fontSize:20,fontFamily:"sans-serif"})),f[b].state=a.state):a.state===c.noteState.CLEARED)};this.update=function(){var a=c.settings,b=d.items,e=c.now,g=e-c.zeroTime;c.score.forEach(function(c,d){var e=(c.time-g)*a.speed+a.hitPosition;d in b?c.emergeTime>g||c.vanishTime<g?(b[d].remove(),delete b[d]):"+"===c.type&&c.state!==b[d].state?f(c,d,e):b[d].position.x=e:c.emergeTime<=g&&c.vanishTime>=g&&f(c,d,e)})}};if("undefined"==typeof window.performance&&(window.performance={}),!window.performance.now){var f=Date.now();window.performance.now=function(){return Date.now()-f}}return d}();
//# sourceMappingURL=youtyping.min.map